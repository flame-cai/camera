<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PRISM Depth - Camera Control</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#07090a;--card:#0f1518;--card2:#141c20;
  --border:#1a2830;--border2:#22333d;
  --a1:#00ffc8;--a2:#ff4444;--a3:#ffd700;--a4:#7c6fff;
  --text:#dde8ec;--muted:#4a6070;--muted2:#243040;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;overflow:hidden}

/* INIT */
#initScreen{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:20px;background:var(--bg);padding:32px 24px;overflow-y:auto}
.logo{font-family:'Syne',sans-serif;font-size:2.8rem;font-weight:800;color:var(--a1);letter-spacing:10px;text-align:center}
.logo-sub{font-size:0.48rem;letter-spacing:5px;text-transform:uppercase;color:var(--muted);text-align:center;margin-top:-12px}
.init-btn{font-family:'DM Mono',monospace;font-size:0.7rem;letter-spacing:3px;text-transform:uppercase;padding:15px 40px;border:1.5px solid var(--a1);background:transparent;color:var(--a1);border-radius:2px;cursor:pointer;-webkit-appearance:none}
.init-btn:active{background:var(--a1);color:#000}
.init-btn:disabled{opacity:0.3;cursor:not-allowed}
.err-box{width:100%;max-width:360px;border:1px solid var(--a2);background:rgba(255,68,68,.06);padding:13px 15px;border-radius:2px;font-size:0.56rem;line-height:1.9;color:#ff8a8a;display:none;white-space:pre-line}
.err-title{font-size:0.6rem;color:var(--a2);font-weight:500;letter-spacing:2px;text-transform:uppercase;margin-bottom:7px}
.hint-box{width:100%;max-width:360px;border:1px solid var(--border);background:var(--card);padding:12px 15px;border-radius:2px;font-size:0.53rem;line-height:2;color:var(--muted);display:none;white-space:pre-line}
.spinner{width:20px;height:20px;border:2px solid var(--border2);border-top-color:var(--a1);border-radius:50%;animation:spin .8s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}

/* APP */
#app{position:fixed;inset:0;display:none;flex-direction:column}

/* VIDEO */
#videoWrap{position:relative;background:#000;width:100%;overflow:hidden;flex:0 0 auto}
video{width:100%;display:block;object-fit:cover}
.flash{position:absolute;inset:0;background:#fff;pointer-events:none;opacity:0}
@keyframes flashOut{0%{opacity:.9}100%{opacity:0}}
.crosshair{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
.crosshair::before{content:'';width:40px;height:1px;background:rgba(0,255,200,.4);position:absolute}
.crosshair::after{content:'';width:1px;height:40px;background:rgba(0,255,200,.4);position:absolute}
.ch-corner{position:absolute;width:12px;height:12px;border-color:rgba(0,255,200,.5);border-style:solid;pointer-events:none}
.ch-tl{top:calc(50% - 20px);left:calc(50% - 20px);border-width:1.5px 0 0 1.5px}
.ch-tr{top:calc(50% - 20px);right:calc(50% - 20px);border-width:1.5px 1.5px 0 0}
.ch-bl{bottom:calc(50% - 20px);left:calc(50% - 20px);border-width:0 0 1.5px 1.5px}
.ch-br{bottom:calc(50% - 20px);right:calc(50% - 20px);border-width:0 1.5px 1.5px 0}
.vid-top{position:absolute;top:0;left:0;right:0;padding:calc(var(--safe-top) + 6px) 10px 6px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none}
.badge{font-size:0.48rem;letter-spacing:1.5px;text-transform:uppercase;background:rgba(0,0,0,.65);border:1px solid rgba(255,255,255,.1);padding:5px 8px;border-radius:2px;line-height:2;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
.live-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--a2);margin-right:4px;vertical-align:middle;animation:blink 1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.1}}
.dist-overlay{position:absolute;bottom:68px;left:0;right:0;text-align:center;pointer-events:none;display:none}
.dist-badge{display:inline-block;font-size:1.4rem;font-family:'Syne',sans-serif;font-weight:700;color:var(--a1);background:rgba(0,0,0,.7);padding:4px 18px;border-radius:3px;border:1px solid var(--a1);text-shadow:0 0 20px rgba(0,255,200,.5)}
.dist-label{font-size:0.45rem;letter-spacing:2px;text-transform:uppercase;color:var(--muted);display:block;margin-top:2px}
.vid-bot{position:absolute;bottom:0;left:0;right:0;padding:6px 14px calc(var(--safe-bot) + 4px);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(transparent,rgba(0,0,0,.8))}
.icon-btn{width:42px;height:42px;border-radius:50%;border:1.5px solid rgba(255,255,255,.2);background:rgba(0,0,0,.5);color:#fff;font-size:1rem;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.icon-btn:active{transform:scale(.88)}
.icon-btn.on{border-color:var(--a1);color:var(--a1);background:rgba(0,255,200,.15)}
.shutter{width:56px;height:56px;border-radius:50%;border:3px solid var(--a1);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none}
.shutter-inner{width:40px;height:40px;border-radius:50%;background:rgba(0,255,200,.1);transition:all .1s}
.shutter:active .shutter-inner{background:var(--a1);transform:scale(.84)}
.mode-btn{font-family:'DM Mono',monospace;font-size:0.44rem;letter-spacing:1.5px;text-transform:uppercase;padding:5px 10px;border:1px solid var(--border2);background:transparent;color:var(--muted);border-radius:2px;cursor:pointer;white-space:nowrap}
.mode-btn.active{border-color:var(--a3);color:var(--a3)}

/* DEPTH CANVAS OVERLAY */
#depthCanvas{position:absolute;inset:0;width:100%;height:100%;opacity:0.65;display:none;pointer-events:none}

/* DEVICE BAR */
.dev-bar{display:flex;overflow-x:auto;background:var(--card2);border-top:1px solid var(--border);flex-shrink:0;-webkit-overflow-scrolling:touch;scrollbar-width:none}
.dev-bar::-webkit-scrollbar{display:none}
.dev-btn{flex-shrink:0;font-family:'DM Mono',monospace;font-size:0.48rem;letter-spacing:1px;text-transform:uppercase;padding:8px 13px;border:none;border-right:1px solid var(--border);border-bottom:2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;white-space:nowrap}
.dev-btn.active{color:var(--a1);border-bottom-color:var(--a1)}
.dev-btn .dev-facing{font-size:0.38rem;display:block;color:var(--muted2);margin-top:1px}

/* WARN */
.warn{background:rgba(255,68,68,.08);border-bottom:1px solid rgba(255,68,68,.3);padding:6px 13px;font-size:0.5rem;color:#ff8a8a;display:none;flex-shrink:0}

/* TABS */
.tabs{display:flex;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{flex:1;padding:9px 2px;font-size:0.44rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);text-align:center;cursor:pointer;border-bottom:2px solid transparent;-webkit-appearance:none;background:none;border-top:none;border-left:none;border-right:none;font-family:'DM Mono',monospace;line-height:1.3}
.tab .ti{font-size:.85rem;display:block;margin-bottom:2px}
.tab.active{color:var(--a1);border-bottom-color:var(--a1)}

/* PANEL */
#panelWrap{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;background:var(--bg);scrollbar-width:none}
#panelWrap::-webkit-scrollbar{display:none}
.tab-panel{display:none;padding:10px 12px 90px}
.tab-panel.active{display:block}

/* SECTION */
.section{margin-bottom:8px;border:1px solid var(--border);border-radius:3px;overflow:hidden;background:var(--card)}
.sec-head{display:flex;align-items:center;justify-content:space-between;padding:10px 12px;background:var(--card2);cursor:pointer;user-select:none;-webkit-user-select:none}
.sec-left{display:flex;align-items:center;gap:8px}
.sec-title{font-size:0.52rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--text)}
.sec-tag{font-size:0.4rem;letter-spacing:1.5px;text-transform:uppercase;border:1px solid var(--a1);color:var(--a1);padding:2px 5px;border-radius:1px}
.sec-tag.warn{border-color:var(--a3);color:var(--a3)}
.sec-chev{font-size:0.5rem;color:var(--muted);transition:transform .2s}
.sec-head.closed .sec-chev{transform:rotate(-90deg)}
.sec-body{padding:12px;display:flex;flex-direction:column;gap:14px}
.sec-body.hidden{display:none}

/* CONTROL */
.ctrl{display:flex;flex-direction:column;gap:5px}
.ctrl-head{display:flex;justify-content:space-between;align-items:center}
.ctrl-name{font-size:0.52rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text)}
.ctrl-val{font-size:0.58rem;color:var(--a1);font-weight:500;letter-spacing:1px;min-width:68px;text-align:right}
.ctrl-range-info{font-size:0.42rem;color:var(--muted);display:flex;justify-content:space-between}
.na-badge{font-size:0.42rem;color:var(--muted);border:1px solid var(--border2);padding:2px 6px;border-radius:1px}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--border2);outline:none;cursor:pointer;border-radius:2px;margin:4px 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:var(--a1);cursor:pointer;border:3px solid var(--bg);box-shadow:0 0 0 1.5px var(--a1)}
input[type=range]:active::-webkit-slider-thumb{transform:scale(1.3)}
input[type=range]:disabled{opacity:.2}
select{width:100%;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'DM Mono',monospace;font-size:0.6rem;padding:10px 11px;outline:none;cursor:pointer;border-radius:2px;-webkit-appearance:none;appearance:none}
select:focus{border-color:var(--a1)}
select:disabled{opacity:.25}
.tog-row{display:flex;align-items:center;justify-content:space-between}
.tog-name{font-size:0.52rem;letter-spacing:1.5px;text-transform:uppercase}
.toggle{position:relative;width:48px;height:26px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.tog-track{position:absolute;inset:0;background:var(--border2);border-radius:13px;cursor:pointer;transition:all .2s;border:1px solid var(--border2)}
.tog-track::before{content:'';position:absolute;width:20px;height:20px;left:2px;top:2px;border-radius:50%;background:var(--muted);transition:all .2s}
input:checked+.tog-track{background:rgba(0,255,200,.12);border-color:var(--a1)}
input:checked+.tog-track::before{transform:translateX(22px);background:var(--a1)}
input:disabled+.tog-track{opacity:.2}

/* DEPTH TAB */
.depth-card{background:var(--card);border:1px solid var(--border);border-radius:3px;overflow:hidden;margin-bottom:8px}
.depth-card-head{padding:10px 12px;background:var(--card2);font-size:0.52rem;letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between}
.depth-card-body{padding:12px}
#bracketCanvas{width:100%;border-radius:2px;display:block;background:#000}
#depthMapCanvas{width:100%;border-radius:2px;display:block;background:#000;margin-top:8px}
.progress-bar{height:3px;background:var(--border2);border-radius:2px;overflow:hidden;margin:8px 0}
.progress-fill{height:100%;background:var(--a1);border-radius:2px;width:0%;transition:width .3s}
.stat-grid{display:grid;grid-template-columns:1fr 1fr 1fr;gap:5px;margin-top:8px}
.stat-cell{background:var(--card2);border:1px solid var(--border);border-radius:2px;padding:7px 8px;text-align:center}
.stat-k{font-size:0.4rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.stat-v{font-size:0.7rem;color:var(--a1);font-weight:500}
.btn-row{display:flex;gap:6px;flex-wrap:wrap}
.dep-btn{font-family:'DM Mono',monospace;font-size:0.52rem;letter-spacing:2px;text-transform:uppercase;padding:11px 14px;border-radius:2px;cursor:pointer;-webkit-appearance:none;flex:1;min-width:80px;text-align:center}

/* INFO */
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.ic{background:var(--card2);border:1px solid var(--border);border-radius:2px;padding:7px 9px}
.ic.full{grid-column:1/-1}
.ik{font-size:0.42rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:2px}
.iv{font-size:0.6rem;color:var(--a1);word-break:break-all;line-height:1.4}
.cap-tbl{width:100%;border-collapse:collapse;font-size:0.5rem}
.cap-tbl th{text-align:left;color:var(--muted);font-size:0.4rem;letter-spacing:2px;text-transform:uppercase;padding:6px 9px;border-bottom:1px solid var(--border);background:var(--card2);font-weight:400}
.cap-tbl td{padding:7px 9px;border-bottom:1px solid var(--border);vertical-align:top;line-height:1.6}
.cap-tbl tr:last-child td{border-bottom:none}
.cap-tbl td:first-child{color:var(--text);width:40%;font-size:0.48rem}
.cap-tbl .ok{color:var(--a1)}
.cap-tbl .no{color:var(--muted)}
.v-chip{display:inline-block;background:var(--card2);border:1px solid var(--border2);padding:1px 5px;margin:1px;border-radius:1px;font-size:0.44rem;color:var(--a1)}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--safe-bot) + 72px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border2);color:var(--text);font-size:0.55rem;letter-spacing:1.5px;padding:8px 16px;border-radius:2px;z-index:999;opacity:0;transition:opacity .2s;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1}
.toast.ok{border-color:var(--a1);color:var(--a1)}
.toast.err{border-color:var(--a2);color:var(--a2)}
.toast.warn{border-color:var(--a3);color:var(--a3)}

.act-btn{flex:1;font-family:'DM Mono',monospace;font-size:0.52rem;letter-spacing:2px;text-transform:uppercase;padding:12px;border-radius:2px;cursor:pointer;-webkit-appearance:none}

.depth-legend{display:flex;align-items:center;gap:8px;margin-top:8px;font-size:0.44rem;color:var(--muted)}
.legend-bar{flex:1;height:8px;border-radius:2px;background:linear-gradient(to right,#0000ff,#00ff00,#ffff00,#ff0000)}
</style>
</head>
<body>

<!-- INIT -->
<div id="initScreen">
  <div>
    <div class="logo">PRISM</div>
    <div class="logo-sub">Depth Camera Control</div>
  </div>
  <div class="spinner" id="spinner"></div>
  <button class="init-btn" id="startBtn" onclick="startCam()">INITIALIZE CAMERA</button>
  <div class="err-box" id="errBox"><div class="err-title" id="errTitle"></div><span id="errMsg"></span></div>
  <div class="hint-box" id="hintBox"></div>
</div>

<!-- APP -->
<div id="app">
  <div id="videoWrap">
    <video id="video" autoplay muted playsinline webkit-playsinline></video>
    <canvas id="depthCanvas"></canvas>
    <div class="flash" id="flash"></div>
    <div class="crosshair">
      <div class="ch-corner ch-tl"></div>
      <div class="ch-corner ch-tr"></div>
      <div class="ch-corner ch-bl"></div>
      <div class="ch-corner ch-br"></div>
    </div>
    <div class="vid-top">
      <div class="badge" id="liveBadge">
        <span class="live-dot"></span>LIVE<br>
        <span id="resText" style="color:var(--muted)">...</span>
      </div>
      <div class="badge" id="readout" style="text-align:right;font-size:0.44rem;line-height:2;min-width:80px"></div>
    </div>
    <div class="dist-overlay" id="distOverlay">
      <div class="dist-badge" id="distBadge">--</div>
      <span class="dist-label">estimated distance</span>
    </div>
    <div class="vid-bot">
      <button class="icon-btn" id="torchBtn" onclick="toggleTorch()" title="Torch">&#128294;</button>
      <div style="display:flex;flex-direction:column;align-items:center;gap:5px">
        <div style="display:flex;gap:6px">
          <button class="mode-btn" id="modeNormal" onclick="setMode('normal')">PHOTO</button>
          <button class="mode-btn active" id="modeDepth" onclick="setMode('depth')">DEPTH</button>
          <button class="mode-btn" id="modeDepthMap" onclick="setMode('depthmap')">MAP</button>
        </div>
        <button class="shutter" onclick="triggerCapture()" title="Capture"><div class="shutter-inner"></div></button>
      </div>
      <button class="icon-btn" onclick="flipCam()" title="Flip">&#128260;</button>
    </div>
  </div>

  <div class="dev-bar" id="devBar"></div>
  <div class="warn" id="warn"></div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('ctrl')" id="tab-ctrl"><span class="ti">&#127917;</span>Controls</button>
    <button class="tab" onclick="showTab('depth')" id="tab-depth"><span class="ti">&#128256;</span>Depth</button>
    <button class="tab" onclick="showTab('caps')" id="tab-caps"><span class="ti">&#128203;</span>Caps</button>
    <button class="tab" onclick="showTab('info')" id="tab-info"><span class="ti">&#9432;&#65039;</span>Info</button>
  </div>

  <div id="panelWrap">
    <!-- CONTROLS -->
    <div class="tab-panel active" id="panel-ctrl">
      <div id="cExposure"></div>
      <div id="cFocus"></div>
      <div id="cWB"></div>
      <div id="cImage"></div>
      <div id="cStream"></div>
      <div id="cTorch"></div>
      <div style="margin-top:10px;display:flex;gap:7px">
        <button class="act-btn" style="border:1px solid var(--border2);background:transparent;color:var(--text)" onclick="resetAll()">RESET</button>
        <button class="act-btn" style="border:1px solid var(--a1);background:transparent;color:var(--a1)" onclick="refresh()">REFRESH</button>
        <button class="act-btn" style="border:1px solid var(--a2);background:transparent;color:var(--a2)" onclick="stopCam()">STOP</button>
      </div>
    </div>

    <!-- DEPTH TAB -->
    <div class="tab-panel" id="panel-depth">

      <!-- Distance readout -->
      <div class="depth-card">
        <div class="depth-card-head">
          Live Distance Estimate
          <span id="liveDistBadge" style="font-size:1rem;color:var(--a1);font-family:'Syne',sans-serif;font-weight:700">--</span>
        </div>
        <div class="depth-card-body">
          <div class="stat-grid">
            <div class="stat-cell"><div class="stat-k">From Focus API</div><div class="stat-v" id="dFocusApi">--</div></div>
            <div class="stat-cell"><div class="stat-k">Sharpness Score</div><div class="stat-v" id="dSharpness">--</div></div>
            <div class="stat-cell"><div class="stat-k">Est. Method</div><div class="stat-v" id="dMethod" style="font-size:0.5rem">--</div></div>
          </div>
          <div style="margin-top:10px;font-size:0.48rem;color:var(--muted);line-height:1.8">
            Tap subject on viewfinder or use DEPTH SCAN for multi-focus bracketed depth estimation.
          </div>
        </div>
      </div>

      <!-- Focus bracketing -->
      <div class="depth-card">
        <div class="depth-card-head">
          Focus Bracket Depth Scan
          <span id="bracketStatus" style="font-size:0.44rem;color:var(--muted)">IDLE</span>
        </div>
        <div class="depth-card-body">
          <div class="ctrl" style="margin-bottom:10px">
            <div class="ctrl-head">
              <span class="ctrl-name">Number of Steps</span>
              <span class="ctrl-val" id="bStepsVal">8</span>
            </div>
            <input type="range" id="bSteps" min="4" max="20" step="1" value="8" oninput="$('bStepsVal').textContent=this.value">
          </div>
          <div class="progress-bar"><div class="progress-fill" id="bracketProgress"></div></div>
          <canvas id="bracketCanvas" height="120"></canvas>
          <canvas id="depthMapCanvas" height="180"></canvas>
          <div class="depth-legend">
            <span>NEAR</span><div class="legend-bar"></div><span>FAR</span>
          </div>
          <div class="stat-grid" id="bracketStats" style="margin-top:8px">
            <div class="stat-cell"><div class="stat-k">Focus Steps</div><div class="stat-v" id="bsSteps">--</div></div>
            <div class="stat-cell"><div class="stat-k">Nearest</div><div class="stat-v" id="bsNear">--</div></div>
            <div class="stat-cell"><div class="stat-k">Farthest</div><div class="stat-v" id="bsFar">--</div></div>
          </div>
          <div class="btn-row" style="margin-top:10px">
            <button class="dep-btn" id="btnBracket" style="border:1px solid var(--a1);background:transparent;color:var(--a1)" onclick="runFocusBracket()">RUN DEPTH SCAN</button>
            <button class="dep-btn" style="border:1px solid var(--border2);background:transparent;color:var(--muted)" onclick="clearDepth()">CLEAR</button>
          </div>
        </div>
      </div>

      <!-- Live depth map -->
      <div class="depth-card">
        <div class="depth-card-head">
          Live Depth Map (Edge-based)
          <button class="mode-btn" id="btnLiveDepth" onclick="toggleLiveDepth()">START</button>
        </div>
        <div class="depth-card-body" style="font-size:0.48rem;color:var(--muted);line-height:1.8">
          Computes a real-time approximate depth map using gradient/edge analysis. 
          Sharp edges = near objects (hot colors), soft/blurry regions = far (cool colors).
          Overlaid on camera view.
        </div>
      </div>

      <!-- Tips -->
      <div class="section" style="margin-top:4px">
        <div class="sec-head" onclick="togSec(this)">
          <div class="sec-left"><span class="sec-title">How Depth Works</span></div>
          <span class="sec-chev">&#9662;</span>
        </div>
        <div class="sec-body" style="font-size:0.5rem;color:var(--muted);line-height:2">
          <b style="color:var(--text)">Focus API:</b> If your camera reports focusDistance, that value (in meters, diopters, or normalized) is used directly.<br>
          <b style="color:var(--text)">Depth from Defocus (DFD):</b> DEPTH SCAN sweeps focus from near to far, captures a frame at each step, and measures sharpness (Laplacian variance) per region. The focus distance at peak sharpness = depth of that region.<br>
          <b style="color:var(--text)">Live Edge Map:</b> Uses Sobel gradient operator on each frame. High gradient = near/sharp. Low gradient = far/blurry. This is an approximation -- works best with manual focus cameras.<br>
          <b style="color:var(--text)">Front camera:</b> Focus is usually fixed (hyperfocal) -- DFD won't work. Use Edge Map only.
        </div>
      </div>
    </div>

    <!-- CAPS -->
    <div class="tab-panel" id="panel-caps">
      <div class="section">
        <div class="sec-head" onclick="togSec(this)">
          <div class="sec-left"><span class="sec-title">All Capabilities &amp; Ranges</span></div>
          <span class="sec-chev">&#9662;</span>
        </div>
        <div class="sec-body">
          <table class="cap-tbl">
            <thead><tr><th>Property</th><th>Range / Values</th></tr></thead>
            <tbody id="capBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- INFO -->
    <div class="tab-panel" id="panel-info">
      <div class="info-grid" id="infoGrid"></div>
      <div style="margin-top:8px" class="section">
        <div class="sec-head" onclick="togSec(this)">
          <div class="sec-left"><span class="sec-title">Current Settings</span></div>
          <span class="sec-chev">&#9662;</span>
        </div>
        <div class="sec-body">
          <table class="cap-tbl">
            <thead><tr><th>Setting</th><th>Value</th></tr></thead>
            <tbody id="setBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<canvas id="captureCanvas" style="display:none"></canvas>
<canvas id="sharpCanvas" style="display:none"></canvas>

<script>
'use strict';

// ---- STATE -------------------------------------------------------
var stream=null, track=null, ic=null, caps={}, sets={};
var torchOn=false, facing='environment', devs=[];
var captureMode='depth';  // normal | depth | depthmap
var liveDepthRunning=false, liveDepthRAF=null;
var bracketRunning=false;
var distTimerRunning=false, distTimer=null;
var lastDepthData=null;

function $(id){return document.getElementById(id);}

// ---- VIEWPORT HEIGHT -----------------------------------------------
function setVH(){
  var vw=window.innerWidth, vh=window.innerHeight;
  var h=vw>vh?Math.round(vh*0.5):Math.round(vh*0.36);
  $('videoWrap').style.height=h+'px';
  $('depthCanvas').width=$('videoWrap').offsetWidth;
  $('depthCanvas').height=h;
}
window.addEventListener('load',function(){
  setVH();
  if(!window.isSecureContext){
    showInitErr('Insecure Context','Camera requires HTTPS or localhost.',
      'Android Chrome: access via http://localhost\niOS Safari: use localhost or https://');
    $('startBtn').disabled=true;return;
  }
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    showInitErr('Camera API Unavailable','getUserMedia not supported.',
      'Use Chrome on Android or Safari 14.3+ on iOS\nMust be on localhost or HTTPS');
    $('startBtn').disabled=true;
  }
});
window.addEventListener('resize',function(){setVH();});
window.addEventListener('orientationchange',function(){setTimeout(setVH,300);});

// ---- CAMERA INIT --------------------------------------------------
// Android multi-camera: enumerate ALL devices first, then let user pick
// We try WITHOUT facingMode constraint so Android exposes all cameras

async function startCam(deviceId, f){
  var btn=$('startBtn');
  btn.disabled=true; btn.textContent='REQUESTING...';
  $('spinner').style.display='block';
  hideErr();

  try{
    if(stream) stream.getTracks().forEach(function(t){t.stop();});

    var constraints;
    if(deviceId){
      // Exact device - use minimal constraints so we don't overconstrain
      constraints={
        video:{
          deviceId:{exact:deviceId},
          width:{ideal:1920}, height:{ideal:1080}
        }, audio:false
      };
    } else if(f){
      constraints={
        video:{facingMode:{exact:f}, width:{ideal:1920}, height:{ideal:1080}},
        audio:false
      };
    } else {
      // First launch: try environment facing, fall back to any
      try{
        constraints={video:{facingMode:{exact:'environment'},width:{ideal:1920},height:{ideal:1080}},audio:false};
        stream=await navigator.mediaDevices.getUserMedia(constraints);
      }catch(e){
        // Fall back to any camera - triggers permission prompt
        constraints={video:{width:{ideal:1920},height:{ideal:1080}},audio:false};
        stream=await navigator.mediaDevices.getUserMedia(constraints);
      }
    }

    if(!stream) stream=await navigator.mediaDevices.getUserMedia(constraints);

    var vid=$('video');
    vid.srcObject=stream;
    await new Promise(function(r){vid.onloadedmetadata=r; setTimeout(r,3000);});
    await vid.play().catch(function(){});

    track=stream.getVideoTracks()[0];
    if(track.getSettings) facing=track.getSettings().facingMode||facing;

    if('ImageCapture' in window){
      try{ic=new ImageCapture(track);}catch(e){ic=null;}
    }

    // Enumerate ALL cameras after permission granted
    await loadDevs();
    readCaps();
    buildAll();
    startOv();
    startDistMonitor();

    $('initScreen').style.display='none';
    $('app').style.display='flex';
    $('app').style.flexDirection='column';
    setVH();
    updateTorchBtn();
    showToast('Camera ready - '+devs.length+' camera(s) found','ok');

  }catch(e){
    handleErr(e);
    btn.disabled=false;
    btn.textContent='TRY AGAIN';
  }
  $('spinner').style.display='none';
}

function handleErr(e){
  var title='Error', msg=e.message||String(e), hint='';
  if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError'){
    title='Permission Denied'; msg='Camera access blocked.';
    hint='Android Chrome:\n  Tap lock icon in address bar\n  Site Settings > Camera > Allow\n\niOS Safari:\n  Settings > Safari > Camera > Allow\n\nThen reload and try again.';
  }else if(e.name==='NotFoundError'){
    title='No Camera Found'; msg='No camera detected.';
    hint='Check no other app is using the camera.';
  }else if(e.name==='NotReadableError'||e.name==='TrackStartError'){
    title='Camera Busy'; msg='Camera in use by another app.';
    hint='Close Zoom, Meet, or other camera apps, then retry.';
  }else if(e.name==='OverconstrainedError'){
    title='Retrying...'; msg='Constraint failed - trying minimal config.';
    navigator.mediaDevices.getUserMedia({video:true,audio:false}).then(function(s){
      stream=s; $('video').srcObject=s;
      return new Promise(function(r){$('video').onloadedmetadata=r;setTimeout(r,2000);});
    }).then(function(){
      track=stream.getVideoTracks()[0];
      readCaps(); buildAll(); startOv(); startDistMonitor();
      $('initScreen').style.display='none';
      $('app').style.display='flex'; $('app').style.flexDirection='column';
      loadDevs();
    }).catch(function(e2){handleErr(e2);});
    return;
  }
  showInitErr(title, msg, hint);
}

async function loadDevs(){
  try{
    // Must call after getUserMedia to get real labels
    var all=await navigator.mediaDevices.enumerateDevices();
    devs=all.filter(function(d){return d.kind==='videoinput';});
    var bar=$('devBar'); bar.innerHTML='';
    var cur=track&&track.getSettings?track.getSettings().deviceId:null;
    devs.forEach(function(d,i){
      var b=document.createElement('button');
      // Try to guess facing from label (Android often includes 'back','front','0','1','2' etc)
      var lbl=d.label||'Camera '+(i+1);
      var facing_guess='';
      var ll=lbl.toLowerCase();
      if(ll.includes('back')||ll.includes('rear')||ll.includes('environment')||ll.includes('main')||ll.match(/camera [0-9]/) ){
        facing_guess='BACK';
      }else if(ll.includes('front')||ll.includes('user')||ll.includes('selfie')||ll.includes('facetime')){
        facing_guess='FRONT';
      }
      var active=d.deviceId===cur;
      b.className='dev-btn'+(active?' active':'');
      b.innerHTML=lbl+(facing_guess?'<span class="dev-facing">'+facing_guess+'</span>':'');
      b.onclick=(function(did){return function(){startCam(did);};})(d.deviceId);
      bar.appendChild(b);
    });
  }catch(e){console.warn('enumerateDevices failed',e);}
}

function flipCam(){
  facing=facing==='environment'?'user':'environment';
  startCam(null,facing);
}

function stopCam(){
  clearInterval(distTimer); distTimerRunning=false;
  stopLiveDepth();
  if(stream) stream.getTracks().forEach(function(t){t.stop();});
  $('video').srcObject=null; stream=null; track=null; ic=null;
  $('app').style.display='none';
  $('initScreen').style.display='flex';
  $('startBtn').disabled=false; $('startBtn').textContent='INITIALIZE CAMERA';
}

function readCaps(){
  if(!track)return;
  caps=track.getCapabilities?track.getCapabilities():{};
  sets=track.getSettings?track.getSettings():{};
}

async function applyC(obj){
  if(!track)return;
  try{
    await track.applyConstraints({advanced:[obj]});
    sets=track.getSettings();
    updReadout();
  }catch(e){
    showWarn('Cannot apply ['+Object.keys(obj).join(',')+'] - '+e.message);
  }
}

function showWarn(msg){
  var w=$('warn'); w.textContent=msg; w.style.display='block';
  clearTimeout(showWarn._t);
  showWarn._t=setTimeout(function(){w.style.display='none';},5000);
}

// ---- BUILD CONTROLS ----------------------------------------------
function buildAll(){buildCtrl();buildCapsTab();buildInfoTab();}

function buildCtrl(){
  buildSec('cExposure','Exposure','LIVE',[
    mkSel('exposureMode','Exposure Mode',caps.exposureMode,sets.exposureMode,function(v){applyC({exposureMode:v});},!!caps.exposureMode),
    mkRange('exposureTime','Exposure Time',caps.exposureTime,sets.exposureTime,'us',function(v){applyC({exposureTime:v});},!!caps.exposureTime),
    mkRange('expComp','Exp Compensation (EV)',caps.exposureCompensation||{min:-3,max:3,step:0.1},
      sets.exposureCompensation!=null?sets.exposureCompensation:0,'EV',
      function(v){applyC({exposureCompensation:v});},!!caps.exposureCompensation),
    mkRange('iso','ISO',caps.iso,sets.iso,'',function(v){applyC({iso:v});},!!caps.iso),
  ]);
  buildSec('cFocus','Focus','LIVE',[
    mkSel('focusMode','Focus Mode',caps.focusMode,sets.focusMode,function(v){
      applyC({focusMode:v});
      // When manual, enable distance slider
      var r=$('focusDist'); if(r) r.disabled=(v!=='manual');
    },!!caps.focusMode),
    mkRange('focusDist','Focus Distance',caps.focusDistance,sets.focusDistance,'m',
      function(v){
        applyC({focusDistance:v});
        updateDistFromFocus(v);
      },
      !!caps.focusDistance),
  ]);
  buildSec('cWB','White Balance','LIVE',[
    mkSel('wbMode','WB Mode',caps.whiteBalanceMode,sets.whiteBalanceMode,function(v){applyC({whiteBalanceMode:v});},!!caps.whiteBalanceMode),
    mkRange('colorTemp','Color Temp',caps.colorTemperature,sets.colorTemperature,'K',function(v){applyC({colorTemperature:v});},!!caps.colorTemperature),
  ]);
  buildSec('cImage','Image Adjustments','LIVE',[
    mkRange('brightness','Brightness',caps.brightness,sets.brightness,'%',function(v){applyC({brightness:v});},!!caps.brightness),
    mkRange('contrast','Contrast',caps.contrast,sets.contrast,'%',function(v){applyC({contrast:v});},!!caps.contrast),
    mkRange('saturation','Saturation',caps.saturation,sets.saturation,'%',function(v){applyC({saturation:v});},!!caps.saturation),
    mkRange('sharpness','Sharpness',caps.sharpness,sets.sharpness,'',function(v){applyC({sharpness:v});},!!caps.sharpness),
    mkRange('pan','Pan',caps.pan,sets.pan,'deg',function(v){applyC({pan:v});},!!caps.pan),
    mkRange('tilt','Tilt',caps.tilt,sets.tilt,'deg',function(v){applyC({tilt:v});},!!caps.tilt),
  ]);
  buildSec('cStream','Resolution & Frame Rate',null,[
    mkRange('rW','Width',caps.width,sets.width,'px',function(v){track.applyConstraints({width:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.width),
    mkRange('rH','Height',caps.height,sets.height,'px',function(v){track.applyConstraints({height:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.height),
    mkRange('fps','Frame Rate',caps.frameRate,sets.frameRate,'fps',function(v){track.applyConstraints({frameRate:{ideal:v}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.frameRate),
    mkSel('resizeMode','Resize Mode',caps.resizeMode,sets.resizeMode,function(v){track.applyConstraints({resizeMode:v}).catch(function(){});},!!caps.resizeMode),
  ]);
  buildSec('cTorch','Torch & Zoom','LIVE',[
    mkTog('tToggle','Torch',sets.torch||false,function(v){torchOn=v;applyC({torch:v});updateTorchBtn();},!!caps.torch),
    mkRange('zoom','Zoom',caps.zoom,sets.zoom,'x',function(v){applyC({zoom:v});},!!caps.zoom),
  ]);
}

function buildSec(mountId,title,tag,items){
  var el=$(mountId); el.innerHTML='';
  var sec=document.createElement('div'); sec.className='section';
  var head=document.createElement('div'); head.className='sec-head';
  head.onclick=function(){togSec(head);};
  var left=document.createElement('div'); left.className='sec-left';
  var t=document.createElement('span'); t.className='sec-title'; t.textContent=title; left.appendChild(t);
  if(tag){var tg=document.createElement('span');tg.className='sec-tag';tg.textContent=tag;left.appendChild(tg);}
  var ch=document.createElement('span'); ch.className='sec-chev'; ch.textContent='\u25be';
  head.appendChild(left); head.appendChild(ch);
  var body=document.createElement('div'); body.className='sec-body';
  items.forEach(function(i){body.appendChild(i);});
  sec.appendChild(head); sec.appendChild(body); el.appendChild(sec);
}

// ---- WIDGET MAKERS -----------------------------------------------
function fmtV(v,unit){
  if(typeof v!=='number') return '--';
  if(unit==='us') return v>=1000?(v/1000).toFixed(2)+'ms':Math.round(v)+'\u00b5s';
  if(unit==='%') return Math.round(v)+'%';
  if(unit==='deg') return Math.round(v)+'\u00b0';
  if(unit==='px') return Math.round(v)+'px';
  if(unit==='fps') return v.toFixed(1)+'fps';
  if(unit==='x') return v.toFixed(2)+'\u00d7';
  if(unit==='m') return v.toFixed(4)+'m';
  if(unit==='EV') return(v>=0?'+':'')+v.toFixed(2)+'EV';
  if(unit==='K') return Math.round(v)+'K';
  return Number.isInteger(v)?v+(unit||''):v.toFixed(2)+(unit||'');
}

function mkRange(id,label,capObj,cur,unit,onChange,supported){
  var wrap=document.createElement('div'); wrap.className='ctrl';
  var hd=document.createElement('div'); hd.className='ctrl-head';
  var nm=document.createElement('span'); nm.className='ctrl-name'; nm.textContent=label; hd.appendChild(nm);
  if(!supported){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;
  }
  var mn=capObj&&capObj.min!=null?capObj.min:0;
  var mx=capObj&&capObj.max!=null?capObj.max:100;
  var st=capObj&&capObj.step!=null?capObj.step:((mx-mn)/100)||1;
  var vl=document.createElement('span'); vl.className='ctrl-val'; vl.id=id+'_v';
  vl.textContent=fmtV(cur!=null?cur:mn,unit); hd.appendChild(vl); wrap.appendChild(hd);
  var ri=document.createElement('div'); ri.className='ctrl-range-info';
  ri.innerHTML='<span>'+fmtV(mn,unit)+'</span><span>min &mdash; max</span><span>'+fmtV(mx,unit)+'</span>';
  wrap.appendChild(ri);
  var r=document.createElement('input'); r.type='range'; r.id=id;
  r.min=mn; r.max=mx; r.step=st; r.value=cur!=null?cur:mn;
  r.addEventListener('input',function(){
    var v=parseFloat(r.value); vl.textContent=fmtV(v,unit); onChange(v);
  });
  wrap.appendChild(r); return wrap;
}

function mkSel(id,label,options,cur,onChange,supported){
  var wrap=document.createElement('div'); wrap.className='ctrl';
  var hd=document.createElement('div'); hd.className='ctrl-head';
  var nm=document.createElement('span'); nm.className='ctrl-name'; nm.textContent=label; hd.appendChild(nm);
  if(!supported||!options||!options.length){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;
  }
  wrap.appendChild(hd);
  var sel=document.createElement('select'); sel.id=id;
  options.forEach(function(o){
    var opt=document.createElement('option'); opt.value=o; opt.textContent=o;
    if(o===cur)opt.selected=true; sel.appendChild(opt);
  });
  sel.addEventListener('change',function(){onChange(sel.value);});
  wrap.appendChild(sel); return wrap;
}

function mkTog(id,label,checked,onChange,supported){
  var wrap=document.createElement('div'); wrap.className='ctrl';
  var row=document.createElement('div'); row.className='tog-row';
  var lbl=document.createElement('span'); lbl.className='tog-name'; lbl.textContent=label; row.appendChild(lbl);
  if(!supported){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';row.appendChild(b);wrap.appendChild(row);return wrap;
  }
  var tog=document.createElement('label'); tog.className='toggle';
  var inp=document.createElement('input'); inp.type='checkbox'; inp.checked=checked; inp.id=id;
  inp.addEventListener('change',function(){onChange(inp.checked);});
  var tr=document.createElement('span'); tr.className='tog-track';
  tog.appendChild(inp); tog.appendChild(tr); row.appendChild(tog); wrap.appendChild(row); return wrap;
}

// ---- CAPABILITIES TABLE ------------------------------------------
var ALL_PROPS=['width','height','frameRate','aspectRatio','facingMode','resizeMode','zoom','torch',
  'focusMode','focusDistance','exposureMode','exposureTime','exposureCompensation','iso',
  'whiteBalanceMode','colorTemperature','brightness','contrast','saturation','sharpness',
  'pan','tilt','sampleRate','channelCount','latency'];

function buildCapsTab(){
  var body=$('capBody'); body.innerHTML='';
  var done={};
  function renderRow(key,val){
    done[key]=true;
    var tr=document.createElement('tr');
    var td1=document.createElement('td'); td1.textContent=key; tr.appendChild(td1);
    var td2=document.createElement('td');
    if(val===undefined||val===null){
      td2.innerHTML='<span class="no">not reported</span>';
    }else if(Array.isArray(val)){
      td2.innerHTML=val.map(function(v){return '<span class="v-chip">'+v+'</span>';}).join('');
    }else if(typeof val==='object'&&('min' in val||'max' in val)){
      var s='';
      if('min' in val&&'max' in val) s+='min: '+fmtCapV(key,val.min)+'&nbsp; max: '+fmtCapV(key,val.max);
      if('step' in val) s+='&nbsp; step: '+val.step;
      td2.innerHTML='<span class="ok">'+s+'</span>';
    }else if(typeof val==='boolean'){
      td2.innerHTML=val?'<span class="ok">true</span>':'<span class="no">false</span>';
    }else{
      td2.innerHTML='<span class="ok">'+val+'</span>';
    }
    tr.appendChild(td2); body.appendChild(tr);
  }
  ALL_PROPS.forEach(function(k){renderRow(k,caps[k]);});
  Object.keys(caps).forEach(function(k){if(!done[k])renderRow(k+' *',caps[k]);});
}

function fmtCapV(key,v){
  if(typeof v!=='number') return String(v);
  var umap={width:'px',height:'px',frameRate:'fps',zoom:'x',focusDistance:'m',
    exposureTime:'us',colorTemperature:'K',pan:'deg',tilt:'deg',exposureCompensation:'EV'};
  return fmtV(v, umap[key]||'');
}

function buildInfoTab(){
  var s=track.getSettings();
  var grid=$('infoGrid'); grid.innerHTML='';
  var devLabel='Unknown';
  for(var i=0;i<devs.length;i++){
    if(devs[i].deviceId===s.deviceId){devLabel=devs[i].label||'Camera '+(i+1);break;}
  }
  var rows=[
    ['Device',devLabel,true],['Facing',s.facingMode||'--',false],
    ['Resolution',(s.width||'?')+'x'+(s.height||'?'),false],
    ['FPS',s.frameRate?(+s.frameRate).toFixed(2)+' fps':'--',false],
    ['Aspect',s.aspectRatio?(+s.aspectRatio).toFixed(4):'--',false],
    ['Resize',s.resizeMode||'--',false],
    ['Exp Mode',s.exposureMode||'--',false],['Focus Mode',s.focusMode||'--',false],
    ['WB Mode',s.whiteBalanceMode||'--',false],['ISO',s.iso!=null?s.iso:'--',false],
    ['EV',s.exposureCompensation!=null?s.exposureCompensation+'EV':'--',false],
    ['Zoom',s.zoom!=null?s.zoom+'x':'--',false],
    ['Torch',s.torch!=null?(s.torch?'ON':'OFF'):'--',false],
    ['Has focusDist',caps.focusDistance?'YES - '+fmtCapV('focusDistance',caps.focusDistance.min)+' to '+fmtCapV('focusDistance',caps.focusDistance.max):'NO',true],
    ['Device ID',(s.deviceId||'--').slice(0,20),true],
  ];
  rows.forEach(function(row){
    var c=document.createElement('div'); c.className='ic'+(row[2]?' full':'');
    c.innerHTML='<div class="ik">'+row[0]+'</div><div class="iv">'+row[1]+'</div>';
    grid.appendChild(c);
  });
  var sb=$('setBody'); sb.innerHTML='';
  var entries=Object.entries(s);
  entries.forEach(function(pair){
    var k=pair[0], v=pair[1];
    var tr=document.createElement('tr');
    var fmt=typeof v==='number'&&v%1!==0?v.toFixed(6):String(v);
    tr.innerHTML='<td>'+k+'</td><td style="color:var(--a1)">'+fmt+'</td>';
    sb.appendChild(tr);
  });
}

// ---- OVERLAY & READOUT -------------------------------------------
var ovTimer=null;
function startOv(){
  clearInterval(ovTimer);
  ovTimer=setInterval(function(){
    if(!track)return;
    var s=track.getSettings();
    $('resText').textContent=(s.width||'?')+'x'+(s.height||'?')+' '+(+(s.frameRate||0)).toFixed(1)+'fps';
    updReadout();
  },1500);
}
function updReadout(){
  if(!track)return;
  var s=track.getSettings();
  var lines=[];
  if(s.facingMode) lines.push(s.facingMode.toUpperCase());
  if(s.focusMode) lines.push('FOC:'+s.focusMode.slice(0,4));
  if(s.exposureMode) lines.push('EXP:'+s.exposureMode.slice(0,4));
  if(s.iso!=null) lines.push('ISO'+s.iso);
  if(s.zoom!=null&&s.zoom!==1) lines.push((+s.zoom).toFixed(1)+'x');
  $('readout').innerHTML=lines.join('<br>');
}

// ---- DISTANCE MONITORING -----------------------------------------
function startDistMonitor(){
  clearInterval(distTimer);
  distTimerRunning=true;
  distTimer=setInterval(function(){
    if(!track)return;
    var s=track.getSettings();
    var dist=null;
    var method='--';
    if(s.focusDistance!=null){
      // focusDistance in meters (spec), some devices use diopters (1/m), some normalized 0-1
      var fd=+s.focusDistance;
      var fdCap=caps.focusDistance;
      if(fdCap){
        if(fdCap.max<=1.0){
          // Normalized 0-1: 0=near (~0.1m), 1=infinity
          // Map: dist = 0.1 + fd*9.9 (rough)
          dist=0.1 + fd*9.9;
          method='focus(norm)';
        }else if(fdCap.max>10){
          // Diopters: dist = 1/fd
          dist=fd>0?1/fd:null;
          method='focus(diop)';
        }else{
          // Likely meters directly
          dist=fd;
          method='focus(m)';
        }
      }
      $('dFocusApi').textContent=fmtDist(dist);
    }else{
      $('dFocusApi').textContent='N/A';
      method='edge';
    }
    updateDistDisplay(dist,method);
  },500);
}

function updateDistFromFocus(v){
  var fdCap=caps.focusDistance;
  var dist=null;
  if(fdCap){
    if(fdCap.max<=1.0){ dist=0.1+v*9.9; }
    else if(fdCap.max>10){ dist=v>0?1/v:null; }
    else{ dist=v; }
  }
  updateDistDisplay(dist,'focus(manual)');
}

function updateDistDisplay(dist, method){
  if(dist!=null&&dist>0&&dist<100){
    var dstr=fmtDist(dist);
    $('distBadge').textContent=dstr;
    $('liveDistBadge').textContent=dstr;
    $('distOverlay').style.display='block';
    $('dMethod').textContent=method;
  }else{
    $('liveDistBadge').textContent='--';
    $('distOverlay').style.display='none';
  }
}

function fmtDist(d){
  if(d==null||isNaN(d)||d<=0) return '--';
  if(d<1) return (d*100).toFixed(1)+'cm';
  if(d>50) return '>50m';
  return d.toFixed(2)+'m';
}

// ---- CAPTURE MODES -----------------------------------------------
function setMode(m){
  captureMode=m;
  document.querySelectorAll('.mode-btn').forEach(function(b){b.classList.remove('active');});
  $('mode'+m.charAt(0).toUpperCase()+m.slice(1)).classList.add('active');
  if(m==='depthmap'){
    startLiveDepth();
  }else{
    stopLiveDepth();
  }
}

async function triggerCapture(){
  if(captureMode==='depth'){
    runFocusBracket();
    showTab('depth');
  }else if(captureMode==='depthmap'){
    captureSingleDepthMap();
  }else{
    snapPhoto();
  }
}

// ---- SNAPSHOT ----------------------------------------------------
async function snapPhoto(){
  var fl=$('flash'); fl.style.animation='none'; fl.style.opacity='0';
  void fl.offsetWidth; fl.style.animation='flashOut 0.4s ease-out forwards';
  try{
    var blob=null;
    if(ic){try{blob=await ic.takePhoto();}catch(e){blob=null;}}
    if(!blob){
      var v=$('video'), c=$('captureCanvas');
      c.width=v.videoWidth; c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0);
      blob=await new Promise(function(r){c.toBlob(r,'image/jpeg',0.97);});
    }
    if(blob){
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a'); a.href=url; a.download='prism-'+Date.now()+'.jpg';
      document.body.appendChild(a); a.click(); document.body.removeChild(a);
      URL.revokeObjectURL(url); showToast('Photo saved!','ok');
    }
  }catch(e){showToast('Capture failed','err');}
}

// ---- FOCUS BRACKETING & DEPTH FROM DEFOCUS -----------------------
async function runFocusBracket(){
  if(bracketRunning){showToast('Already running...','warn');return;}
  if(!caps.focusDistance||!caps.focusMode){
    showToast('Focus control not supported on this camera','warn');
    // Still try edge-based on current frame
    captureSingleDepthMap();
    return;
  }

  bracketRunning=true;
  var btn=$('btnBracket');
  btn.textContent='SCANNING...'; btn.disabled=true;
  $('bracketStatus').textContent='RUNNING';

  var steps=parseInt($('bSteps').value)||8;
  var fdMin=caps.focusDistance.min;
  var fdMax=caps.focusDistance.max;
  var vid=$('video');
  var W=vid.videoWidth||640, H=vid.videoHeight||480;

  // Switch to manual focus
  try{await applyC({focusMode:'manual'});}catch(e){}

  var sharpMaps=[]; // array of {fd, sharpnessMap}
  var bracketImages=[];
  var sc=$('sharpCanvas');
  sc.width=W; sc.height=H;
  var sctx=sc.getContext('2d');

  for(var i=0;i<steps;i++){
    var fd=fdMin+(fdMax-fdMin)*(i/(steps-1));
    try{await applyC({focusDistance:fd});}catch(e){}
    // Wait for focus to settle
    await sleep(300);

    // Capture frame
    sctx.drawImage(vid,0,0,W,H);
    var imgData=sctx.getImageData(0,0,W,H);

    // Compute Laplacian variance map (grid of NxM cells)
    var gridW=16, gridH=12;
    var sharpMap=computeSharpnessMap(imgData,W,H,gridW,gridH);
    sharpMaps.push({fd:fd, map:sharpMap});
    bracketImages.push({fd:fd, data:imgData.data.slice(0)});

    // Update progress
    $('bracketProgress').style.width=Math.round((i+1)/steps*100)+'%';
    $('bracketStatus').textContent='Step '+(i+1)+'/'+steps;

    // Draw strip in bracket canvas
    drawBracketStrip(bracketImages, $('bracketCanvas'), W, H, steps);

    await sleep(20);
  }

  // Compute depth map from sharpness maps
  var gridW=16, gridH=12;
  var depthMap=computeDepthFromSharpness(sharpMaps, gridW, gridH, fdMin, fdMax);
  lastDepthData={map:depthMap, gW:gridW, gH:gridH, fdMin:fdMin, fdMax:fdMax};

  // Render depth map
  renderDepthMap(depthMap, gridW, gridH, $('depthMapCanvas'));

  // Stats
  $('bsSteps').textContent=steps;
  var dvals=depthMap.filter(function(v){return v>0;});
  if(dvals.length){
    var sorted=dvals.slice().sort(function(a,b){return a-b;});
    $('bsNear').textContent=fmtDist(sorted[0]);
    $('bsFar').textContent=fmtDist(sorted[sorted.length-1]);
  }

  // Restore auto focus
  try{
    if(caps.focusMode&&caps.focusMode.includes('continuous')){
      await applyC({focusMode:'continuous'});
    }
  }catch(e){}

  btn.textContent='RUN DEPTH SCAN'; btn.disabled=false;
  $('bracketStatus').textContent='DONE';
  $('bracketProgress').style.width='100%';
  bracketRunning=false;
  showToast('Depth scan complete!','ok');
}

async function sleep(ms){
  return new Promise(function(r){setTimeout(r,ms);});
}

function computeSharpnessMap(imgData,W,H,gW,gH){
  var data=imgData.data;
  var cellW=Math.floor(W/gW), cellH=Math.floor(H/gH);
  var map=[];
  for(var gy=0;gy<gH;gy++){
    for(var gx=0;gx<gW;gx++){
      var x0=gx*cellW, y0=gy*cellH;
      var x1=Math.min(x0+cellW,W), y1=Math.min(y0+cellH,H);
      // Laplacian variance
      var sum=0, sumSq=0, n=0;
      for(var y=y0+1;y<y1-1;y++){
        for(var x=x0+1;x<x1-1;x++){
          // Get grayscale
          var idx=(y*W+x)*4;
          var g=0.299*data[idx]+0.587*data[idx+1]+0.114*data[idx+2];
          // Laplacian: 4*center - top - bottom - left - right
          var it=((y-1)*W+x)*4, ib=((y+1)*W+x)*4;
          var il=(y*W+(x-1))*4, ir=(y*W+(x+1))*4;
          var gt=0.299*data[it]+0.587*data[it+1]+0.114*data[it+2];
          var gb=0.299*data[ib]+0.587*data[ib+1]+0.114*data[ib+2];
          var gl=0.299*data[il]+0.587*data[il+1]+0.114*data[il+2];
          var gr=0.299*data[ir]+0.587*data[ir+1]+0.114*data[ir+2];
          var lap=4*g-gt-gb-gl-gr;
          sum+=lap; sumSq+=lap*lap; n++;
        }
      }
      var variance=n>0?(sumSq/n - (sum/n)*(sum/n)):0;
      map.push(variance);
    }
  }
  return map;
}

function computeDepthFromSharpness(sharpMaps, gW, gH, fdMin, fdMax){
  var numCells=gW*gH;
  var depthMap=new Array(numCells).fill(0);
  for(var cell=0;cell<numCells;cell++){
    var maxSharp=-1, bestFd=0;
    sharpMaps.forEach(function(sm){
      if(sm.map[cell]>maxSharp){
        maxSharp=sm.map[cell]; bestFd=sm.fd;
      }
    });
    // Convert fd to distance using same heuristic as live monitor
    var dist=bestFd;
    if(caps.focusDistance){
      var fdCap=caps.focusDistance;
      if(fdCap.max<=1.0){ dist=0.1+bestFd*9.9; }
      else if(fdCap.max>10){ dist=bestFd>0?1/bestFd:10; }
    }
    depthMap[cell]=dist;
  }
  return depthMap;
}

function drawBracketStrip(images,canvas,W,H,totalSteps){
  var ctx=canvas.getContext('2d');
  var cw=canvas.clientWidth||canvas.width;
  canvas.width=cw; // actual px
  var ch=canvas.height;
  var sw=Math.floor(cw/totalSteps);
  ctx.fillStyle='#000'; ctx.fillRect(0,0,cw,ch);
  images.forEach(function(img,i){
    // Draw a small column from the center of this capture
    var sc=$('sharpCanvas');
    var x=i*sw;
    ctx.drawImage(sc, Math.floor(W/2)-Math.floor(W/totalSteps/2), 0, Math.floor(W/totalSteps), H,
                  x, 0, sw, ch);
  });
}

function renderDepthMap(depthMap,gW,gH,canvas){
  var ctx=canvas.getContext('2d');
  var cw=canvas.clientWidth||300;
  canvas.width=cw;
  var ch=canvas.height||180;
  var cellW=cw/gW, cellH=ch/gH;

  var validVals=depthMap.filter(function(v){return v>0;});
  if(!validVals.length) return;
  var dmin=Math.min.apply(null,validVals);
  var dmax=Math.max.apply(null,validVals);
  var range=dmax-dmin||1;

  for(var i=0;i<depthMap.length;i++){
    var gy=Math.floor(i/gW), gx=i%gW;
    var t=(depthMap[i]-dmin)/range; // 0=near, 1=far
    // Color: near=red, mid=green, far=blue (like heatmap)
    var r,g,b;
    if(t<0.5){r=Math.round(255*(1-t*2));g=Math.round(255*t*2);b=0;}
    else{r=0;g=Math.round(255*(1-(t-0.5)*2));b=Math.round(255*(t-0.5)*2);}
    ctx.fillStyle='rgb('+r+','+g+','+b+')';
    ctx.fillRect(Math.floor(gx*cellW), Math.floor(gy*cellH),
                 Math.ceil(cellW)+1, Math.ceil(cellH)+1);
  }

  // Label corners
  ctx.font='9px monospace'; ctx.fillStyle='rgba(255,255,255,0.8)';
  ctx.fillText(fmtDist(dmin)+'(near)',2,12);
  ctx.fillText(fmtDist(dmax)+'(far)',2,ch-4);
}

function clearDepth(){
  var bc=$('bracketCanvas'); bc.getContext('2d').clearRect(0,0,bc.width,bc.height);
  var dc=$('depthMapCanvas'); dc.getContext('2d').clearRect(0,0,dc.width,dc.height);
  $('bracketProgress').style.width='0';
  $('bracketStatus').textContent='IDLE';
  $('bsSteps').textContent='--'; $('bsNear').textContent='--'; $('bsFar').textContent='--';
  lastDepthData=null;
}

// ---- LIVE DEPTH MAP (EDGE/SOBEL BASED) ---------------------------
function toggleLiveDepth(){
  if(liveDepthRunning){ stopLiveDepth(); }
  else{ startLiveDepth(); }
}

function startLiveDepth(){
  if(liveDepthRunning) return;
  liveDepthRunning=true;
  $('btnLiveDepth').textContent='STOP';
  $('btnLiveDepth').style.borderColor='var(--a2)';
  $('btnLiveDepth').style.color='var(--a2)';
  $('depthCanvas').style.display='block';
  liveDepthLoop();
}

function stopLiveDepth(){
  liveDepthRunning=false;
  if(liveDepthRAF) cancelAnimationFrame(liveDepthRAF);
  $('btnLiveDepth').textContent='START';
  $('btnLiveDepth').style.borderColor='';$('btnLiveDepth').style.color='';
  $('depthCanvas').style.display='none';
}

function liveDepthLoop(){
  if(!liveDepthRunning) return;
  var vid=$('video');
  if(vid.readyState>=2){
    var W=vid.videoWidth, H=vid.videoHeight;
    if(W&&H){
      var sc=$('sharpCanvas');
      sc.width=W; sc.height=H;
      var ctx=sc.getContext('2d');
      ctx.drawImage(vid,0,0,W,H);
      var imgData=ctx.getImageData(0,0,W,H);
      renderLiveEdgeDepth(imgData, W, H);
    }
  }
  liveDepthRAF=requestAnimationFrame(liveDepthLoop);
}

function renderLiveEdgeDepth(imgData, W, H){
  var dc=$('depthCanvas');
  var dW=dc.width, dH=dc.height;
  var ctx=dc.getContext('2d');
  ctx.clearRect(0,0,dW,dH);
  var data=imgData.data;

  // Compute Sobel gradient magnitude, downsample to 32x24 grid
  var gW=32, gH=24;
  var cellW=Math.floor(W/gW), cellH=Math.floor(H/gH);
  var edgeMap=[];
  var maxEdge=0;

  for(var gy=0;gy<gH;gy++){
    for(var gx=0;gx<gW;gx++){
      var cx=gx*cellW+Math.floor(cellW/2);
      var cy=gy*cellH+Math.floor(cellH/2);
      cx=Math.max(1,Math.min(W-2,cx));
      cy=Math.max(1,Math.min(H-2,cy));
      // Sobel
      function px(xx,yy){
        var idx=(yy*W+xx)*4;
        return 0.299*data[idx]+0.587*data[idx+1]+0.114*data[idx+2];
      }
      var gx_=px(cx+1,cy-1)+2*px(cx+1,cy)+px(cx+1,cy+1)-px(cx-1,cy-1)-2*px(cx-1,cy)-px(cx-1,cy+1);
      var gy_=px(cx-1,cy+1)+2*px(cx,cy+1)+px(cx+1,cy+1)-px(cx-1,cy-1)-2*px(cx,cy-1)-px(cx+1,cy-1);
      var mag=Math.sqrt(gx_*gx_+gy_*gy_);
      edgeMap.push(mag);
      if(mag>maxEdge) maxEdge=mag;
    }
  }

  if(maxEdge<0.1) return;

  // Render colored overlay
  var cellDW=dW/gW, cellDH=dH/gH;
  edgeMap.forEach(function(mag,i){
    var gy2=Math.floor(i/gW), gx2=i%gW;
    var t=mag/maxEdge; // 0=far/blurry, 1=near/sharp
    // Color: high edge (near) = hot red/yellow, low edge (far) = cool blue
    var r,g,b,a;
    if(t>0.6){r=255;g=Math.round(255*(1-t)*2.5);b=0;a=0.7;}
    else if(t>0.3){r=255;g=255;b=0;a=0.5;}
    else{r=0;g=Math.round(100*t);b=200;a=0.3;}
    ctx.fillStyle='rgba('+r+','+g+','+b+','+a.toFixed(2)+')';
    ctx.fillRect(Math.floor(gx2*cellDW),Math.floor(gy2*cellDH),Math.ceil(cellDW)+1,Math.ceil(cellDH)+1);
  });

  // Center sharpness indicator
  var centerIdx=Math.floor(gH/2)*gW+Math.floor(gW/2);
  var centerEdge=edgeMap[centerIdx]/maxEdge;
  $('dSharpness').textContent=(centerEdge*100).toFixed(0)+'%';
}

function captureSingleDepthMap(){
  var vid=$('video');
  var W=vid.videoWidth, H=vid.videoHeight;
  var sc=$('sharpCanvas');
  sc.width=W; sc.height=H;
  var ctx=sc.getContext('2d');
  ctx.drawImage(vid,0,0,W,H);
  var imgData=ctx.getImageData(0,0,W,H);
  var dc=$('depthMapCanvas');
  dc.width=dc.clientWidth||300;
  dc.height=180;
  renderLiveEdgeDepth(imgData,W,H);
  showToast('Depth map captured','ok');
  showTab('depth');
}

// ---- TORCH -------------------------------------------------------
async function toggleTorch(){
  if(!caps.torch){showToast('Torch not supported','warn');return;}
  torchOn=!torchOn;
  await applyC({torch:torchOn});
  updateTorchBtn();
  var t=$('tToggle'); if(t) t.checked=torchOn;
}
function updateTorchBtn(){
  var b=$('torchBtn');
  torchOn?b.classList.add('on'):b.classList.remove('on');
}

// ---- RESET / REFRESH / STOP --------------------------------------
async function resetAll(){
  if(!track)return;
  var o={};
  if(caps.brightness) o.brightness=Math.round((caps.brightness.min+caps.brightness.max)/2);
  if(caps.contrast) o.contrast=Math.round((caps.contrast.min+caps.contrast.max)/2);
  if(caps.saturation) o.saturation=Math.round((caps.saturation.min+caps.saturation.max)/2);
  if(caps.sharpness) o.sharpness=Math.round((caps.sharpness.min+caps.sharpness.max)/2);
  if(caps.exposureCompensation) o.exposureCompensation=0;
  if(caps.zoom) o.zoom=caps.zoom.min;
  if(caps.torch) o.torch=false;
  if(Object.keys(o).length) await applyC(o);
  torchOn=false; updateTorchBtn(); buildAll(); showToast('Reset','ok');
}
function refresh(){readCaps();buildAll();showToast('Refreshed','ok');}

// ---- UI HELPERS --------------------------------------------------
function togSec(h){h.classList.toggle('closed');h.nextElementSibling.classList.toggle('hidden');}
function showTab(n){
  document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
  $('panel-'+n).classList.add('active'); $('tab-'+n).classList.add('active');
  $('panelWrap').scrollTop=0;
}
var _tt=null;
function showToast(msg,type){
  var t=$('toast'); t.textContent=msg; t.className='toast show'+(type?' '+type:'');
  clearTimeout(_tt); _tt=setTimeout(function(){t.className='toast';},2500);
}
function showInitErr(title,msg,hint){
  $('errTitle').textContent=title; $('errMsg').textContent=msg; $('errBox').style.display='block';
  if(hint){$('hintBox').textContent=hint; $('hintBox').style.display='block';}
}
function hideErr(){$('errBox').style.display='none'; $('hintBox').style.display='none';}
</script>
</body>
</html>
