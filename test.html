<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0,maximum-scale=1.0,user-scalable=no,viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PRISM Depth Research</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#05080a;--card:#0d1318;--card2:#111b22;--card3:#16222c;
  --border:#182530;--border2:#1e3040;
  --a1:#00ffc8;--a2:#ff4444;--a3:#ffd700;--a4:#a78bfa;--a5:#38bdf8;--a6:#fb923c;
  --text:#dce8ec;--muted:#4a6070;--muted2:#1a2a38;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;overflow:hidden;-webkit-font-smoothing:antialiased}

/* INIT */
#initScreen{position:fixed;inset:0;z-index:300;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:16px;background:var(--bg);padding:24px 20px;overflow-y:auto}
.logo{font-family:'Syne',sans-serif;font-size:2.5rem;font-weight:800;color:var(--a1);letter-spacing:10px;text-align:center}
.logo-tag{font-size:0.42rem;letter-spacing:5px;text-transform:uppercase;color:var(--muted);text-align:center;margin-top:-8px}
.logo-desc{font-size:0.48rem;color:var(--muted);text-align:center;line-height:1.9;max-width:320px}
.ibtn{font-family:'DM Mono',monospace;font-size:0.66rem;letter-spacing:3px;text-transform:uppercase;padding:13px 34px;border:1.5px solid var(--a1);background:transparent;color:var(--a1);border-radius:2px;cursor:pointer;-webkit-appearance:none}
.ibtn:active{background:var(--a1);color:#000}.ibtn:disabled{opacity:.3;cursor:not-allowed}
.ibtn.sec{border-color:var(--border2);color:var(--muted);display:none}
.err-box{width:100%;max-width:340px;border:1px solid var(--a2);background:rgba(255,68,68,.05);padding:11px 13px;border-radius:2px;font-size:0.54rem;line-height:1.9;color:#ff8a8a;display:none;white-space:pre-line}
.err-title{font-size:0.56rem;color:var(--a2);font-weight:500;letter-spacing:2px;text-transform:uppercase;margin-bottom:5px}
.hint-box{width:100%;max-width:340px;border:1px solid var(--border);background:var(--card);padding:10px 13px;border-radius:2px;font-size:0.5rem;line-height:2;color:var(--muted);display:none;white-space:pre-line}
.spin{width:18px;height:18px;border:2px solid var(--border2);border-top-color:var(--a1);border-radius:50%;animation:sp .8s linear infinite;display:none}
@keyframes sp{to{transform:rotate(360deg)}}

/* APP */
#app{position:fixed;inset:0;display:none;flex-direction:column}

/* VIDEO */
#vWrap{position:relative;background:#000;width:100%;overflow:hidden;flex:0 0 auto}
video{width:100%;display:block;object-fit:cover}
#edgeOverlay{position:absolute;inset:0;width:100%;height:100%;display:none;pointer-events:none;opacity:.68;image-rendering:pixelated}
.flash{position:absolute;inset:0;background:#fff;pointer-events:none;opacity:0}
@keyframes fOut{0%{opacity:.85}100%{opacity:0}}
.xhair{position:absolute;inset:0;pointer-events:none}
.xhair::before{content:'';position:absolute;width:28px;height:1px;background:rgba(0,255,200,.4);top:50%;left:50%;transform:translate(-50%,-50%)}
.xhair::after{content:'';position:absolute;width:1px;height:28px;background:rgba(0,255,200,.4);top:50%;left:50%;transform:translate(-50%,-50%)}
.xc{position:absolute;width:9px;height:9px;border-color:rgba(0,255,200,.45);border-style:solid;pointer-events:none}
.xtl{top:calc(50%-14px);left:calc(50%-14px);border-width:1.5px 0 0 1.5px}
.xtr{top:calc(50%-14px);right:calc(50%-14px);border-width:1.5px 1.5px 0 0}
.xbl{bottom:calc(50%-14px);left:calc(50%-14px);border-width:0 0 1.5px 1.5px}
.xbr{bottom:calc(50%-14px);right:calc(50%-14px);border-width:0 1.5px 1.5px 0}
.vid-top{position:absolute;top:0;left:0;right:0;padding:calc(var(--safe-top)+5px) 9px 5px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none;gap:5px}
.hud{font-size:0.42rem;letter-spacing:1.5px;text-transform:uppercase;background:rgba(0,0,0,.72);border:1px solid rgba(255,255,255,.07);padding:4px 7px;border-radius:2px;line-height:2;backdrop-filter:blur(8px);-webkit-backdrop-filter:blur(8px)}
.ldot{display:inline-block;width:4px;height:4px;border-radius:50%;background:var(--a2);margin-right:3px;vertical-align:middle;animation:bl 1s infinite}
@keyframes bl{0%,100%{opacity:1}50%{opacity:.08}}
#distHud{position:absolute;left:50%;transform:translateX(-50%);bottom:66px;text-align:center;pointer-events:none;display:none}
.dist-num{font-family:'Syne',sans-serif;font-size:1.5rem;font-weight:800;color:var(--a1);text-shadow:0 0 20px rgba(0,255,200,.45);display:block;line-height:1}
.dist-lbl{font-size:0.38rem;letter-spacing:2px;text-transform:uppercase;color:var(--a1);opacity:.65;margin-top:1px;display:block}
.dist-meth{font-size:0.36rem;letter-spacing:1px;color:var(--muted);display:block}
.vid-bot{position:absolute;bottom:0;left:0;right:0;padding:5px 10px calc(var(--safe-bot)+3px);display:flex;justify-content:space-between;align-items:center;background:linear-gradient(transparent,rgba(0,0,0,.88))}
.iBtn{width:38px;height:38px;border-radius:50%;border:1.5px solid rgba(255,255,255,.16);background:rgba(0,0,0,.55);color:#fff;font-size:.9rem;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none;flex-shrink:0}
.iBtn:active{transform:scale(.86)}.iBtn.on{border-color:var(--a1);color:var(--a1);background:rgba(0,255,200,.1)}
.shutter{width:52px;height:52px;border-radius:50%;border:2.5px solid var(--a1);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none;flex-shrink:0}
.sh-in{width:36px;height:36px;border-radius:50%;background:rgba(0,255,200,.08);transition:all .1s}
.shutter:active .sh-in{background:var(--a1);transform:scale(.8)}
.mpills{display:flex;flex-direction:column;align-items:center;gap:3px}
.mpill{font-family:'DM Mono',monospace;font-size:0.38rem;letter-spacing:1.5px;text-transform:uppercase;padding:3px 7px;border:1px solid var(--border2);background:rgba(0,0,0,.5);color:var(--muted);border-radius:10px;cursor:pointer;white-space:nowrap}
.mpill.active{border-color:var(--a3);color:var(--a3);background:rgba(255,215,0,.05)}

/* SCAN HUD */
#scanHud{position:absolute;top:calc(var(--safe-top)+32px);left:50%;transform:translateX(-50%);display:none;pointer-events:none}
.scan-inner{background:rgba(0,0,0,.8);border:1px solid var(--a3);border-radius:2px;padding:5px 12px;text-align:center;font-size:0.44rem;letter-spacing:1.5px;color:var(--a3);white-space:nowrap}
.scan-pbar{height:2px;background:var(--border2);border-radius:1px;overflow:hidden;margin-top:3px}
.scan-pfill{height:100%;background:var(--a3);border-radius:1px;width:0%;transition:width .2s}

/* DEVICE BAR */
.devbar{display:flex;overflow-x:auto;background:var(--card2);border-top:1px solid var(--border);flex-shrink:0;scrollbar-width:none}
.devbar::-webkit-scrollbar{display:none}
.dbtn{flex-shrink:0;font-family:'DM Mono',monospace;font-size:0.44rem;letter-spacing:.8px;text-transform:uppercase;padding:7px 11px;border:none;border-right:1px solid var(--border);border-bottom:2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;white-space:nowrap;line-height:1.4;text-align:left}
.dbtn.active{color:var(--a1);border-bottom-color:var(--a1)}
.dfacing{font-size:0.32rem;color:var(--muted2);display:block}

/* WARN */
.warn{background:rgba(255,68,68,.07);border-bottom:1px solid rgba(255,68,68,.2);padding:5px 11px;font-size:0.46rem;color:#ff8a8a;display:none;flex-shrink:0}

/* TABS */
.tabs{display:flex;background:var(--card);border-bottom:1px solid var(--border);flex-shrink:0;overflow-x:auto;scrollbar-width:none}
.tabs::-webkit-scrollbar{display:none}
.tab{flex:0 0 auto;padding:7px 9px;font-size:0.4rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);text-align:center;cursor:pointer;border-bottom:2px solid transparent;-webkit-appearance:none;background:none;border-top:none;border-left:none;border-right:none;font-family:'DM Mono',monospace;line-height:1.3;white-space:nowrap}
.tab .ti{font-size:.75rem;display:block;margin-bottom:1px}
.tab.active{color:var(--a1);border-bottom-color:var(--a1)}

/* PANEL */
#panelWrap{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;background:var(--bg);scrollbar-width:none}
#panelWrap::-webkit-scrollbar{display:none}
.tp{display:none;padding:7px 9px 80px}
.tp.active{display:block}

/* SECTION */
.sec{margin-bottom:6px;border:1px solid var(--border);border-radius:3px;overflow:hidden;background:var(--card)}
.sh{display:flex;align-items:center;justify-content:space-between;padding:8px 10px;background:var(--card2);cursor:pointer;user-select:none;-webkit-user-select:none}
.sl{display:flex;align-items:center;gap:6px}
.st{font-size:0.48rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--text)}
.stag{font-size:0.36rem;letter-spacing:1px;text-transform:uppercase;border:1px solid var(--a1);color:var(--a1);padding:1px 4px;border-radius:1px}
.stag.y{border-color:var(--a3);color:var(--a3)}.stag.p{border-color:var(--a4);color:var(--a4)}.stag.b{border-color:var(--a5);color:var(--a5)}.stag.o{border-color:var(--a6);color:var(--a6)}
.sch{font-size:0.46rem;color:var(--muted);transition:transform .2s}
.sh.closed .sch{transform:rotate(-90deg)}
.sb{padding:9px 10px;display:flex;flex-direction:column;gap:12px}
.sb.hidden{display:none}

/* CTRL */
.ctrl{display:flex;flex-direction:column;gap:4px}
.ch2{display:flex;justify-content:space-between;align-items:center}
.cn{font-size:0.48rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text)}
.cv{font-size:0.54rem;color:var(--a1);font-weight:500;min-width:62px;text-align:right}
.cri{font-size:0.38rem;color:var(--muted);display:flex;justify-content:space-between}
.nab{font-size:0.38rem;color:var(--muted);border:1px solid var(--border2);padding:2px 5px;border-radius:1px}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:4px;background:var(--border2);outline:none;cursor:pointer;border-radius:2px;margin:3px 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:var(--a1);cursor:pointer;border:3px solid var(--bg);box-shadow:0 0 0 1.5px var(--a1)}
input[type=range]:active::-webkit-slider-thumb{transform:scale(1.25)}
input[type=range]:disabled{opacity:.15}
select{width:100%;background:var(--bg);border:1px solid var(--border2);color:var(--text);font-family:'DM Mono',monospace;font-size:0.56rem;padding:9px 10px;outline:none;cursor:pointer;border-radius:2px;-webkit-appearance:none;appearance:none}
select:focus{border-color:var(--a1)}
select:disabled{opacity:.2}
.trow{display:flex;align-items:center;justify-content:space-between}
.tn{font-size:0.48rem;letter-spacing:1.5px;text-transform:uppercase}
.tog{position:relative;width:44px;height:22px;flex-shrink:0}
.tog input{opacity:0;width:0;height:0}
.ttr{position:absolute;inset:0;background:var(--border2);border-radius:11px;cursor:pointer;transition:all .2s;border:1px solid var(--border2)}
.ttr::before{content:'';position:absolute;width:16px;height:16px;left:2px;top:2px;border-radius:50%;background:var(--muted);transition:all .2s}
input:checked+.ttr{background:rgba(0,255,200,.1);border-color:var(--a1)}
input:checked+.ttr::before{transform:translateX(22px);background:var(--a1)}
input:disabled+.ttr{opacity:.15}

/* DEPTH CARDS */
.dcrd{background:var(--card);border:1px solid var(--border);border-radius:3px;overflow:hidden;margin-bottom:7px}
.dch{padding:8px 10px;background:var(--card2);font-size:0.48rem;letter-spacing:2px;text-transform:uppercase;display:flex;align-items:center;justify-content:space-between;gap:6px;flex-wrap:wrap}
.dcb{padding:9px 10px}
.sg{display:grid;grid-template-columns:repeat(3,1fr);gap:3px}
.sg2{display:grid;grid-template-columns:repeat(2,1fr);gap:3px}
.sg4{display:grid;grid-template-columns:repeat(4,1fr);gap:3px}
.sc{background:var(--card2);border:1px solid var(--border);border-radius:2px;padding:5px 7px;text-align:center}
.sk{font-size:0.36rem;color:var(--muted);text-transform:uppercase;letter-spacing:.8px;margin-bottom:2px}
.sv{font-size:0.64rem;color:var(--a1);font-weight:500;word-break:break-all;line-height:1.2}
.sv.sm{font-size:0.48rem}
.pbar{height:3px;background:var(--border2);border-radius:2px;overflow:hidden;margin:6px 0}
.pfill{height:100%;background:var(--a1);border-radius:2px;width:0%;transition:width .2s}
canvas.dc{width:100%;display:block;background:#000;border-radius:2px;image-rendering:pixelated}
.dleg{display:flex;align-items:center;gap:5px;margin-top:4px;font-size:0.38rem;color:var(--muted)}
.lbar{flex:1;height:5px;border-radius:2px}
.brow{display:flex;gap:4px;flex-wrap:wrap;margin-top:7px}
.db2{font-family:'DM Mono',monospace;font-size:0.44rem;letter-spacing:1.5px;text-transform:uppercase;padding:9px 10px;border-radius:2px;cursor:pointer;-webkit-appearance:none;flex:1;min-width:60px;text-align:center;background:transparent}

/* ALGO GRID */
.algo-grid{display:grid;grid-template-columns:repeat(2,1fr);gap:3px;margin-bottom:8px}
.atab{font-family:'DM Mono',monospace;font-size:0.38rem;letter-spacing:1px;text-transform:uppercase;padding:6px 5px;border:1px solid var(--border2);background:transparent;color:var(--muted);border-radius:1px;cursor:pointer;text-align:center;line-height:1.4}
.atab.active{border-color:var(--a4);color:var(--a4);background:rgba(167,139,250,.07)}

/* CAPS TABLE */
.cap-tbl{width:100%;border-collapse:collapse;font-size:0.46rem}
.cap-tbl th{text-align:left;color:var(--muted);font-size:0.36rem;letter-spacing:1.5px;text-transform:uppercase;padding:5px 8px;border-bottom:1px solid var(--border);background:var(--card2);font-weight:400}
.cap-tbl td{padding:6px 8px;border-bottom:1px solid var(--border);vertical-align:top;line-height:1.6}
.cap-tbl tr:last-child td{border-bottom:none}
.cap-tbl td:first-child{color:var(--text);width:36%}
.ok{color:var(--a1)}.no{color:var(--muted)}
.vc{display:inline-block;background:var(--card2);border:1px solid var(--border2);padding:1px 4px;margin:1px;border-radius:1px;font-size:0.4rem;color:var(--a1)}

/* INFO */
.igrid{display:grid;grid-template-columns:1fr 1fr;gap:4px}
.ic{background:var(--card2);border:1px solid var(--border);border-radius:2px;padding:6px 8px}
.ic.full{grid-column:1/-1}
.ik{font-size:0.38rem;color:var(--muted);text-transform:uppercase;letter-spacing:1px;margin-bottom:2px}
.iv{font-size:0.56rem;color:var(--a1);word-break:break-all;line-height:1.3}

/* TOAST */
.toast{position:fixed;bottom:calc(var(--safe-bot)+64px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border2);color:var(--text);font-size:0.5rem;letter-spacing:1.5px;padding:7px 14px;border-radius:2px;z-index:999;opacity:0;transition:opacity .2s;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1}.toast.ok{border-color:var(--a1);color:var(--a1)}.toast.err{border-color:var(--a2);color:var(--a2)}.toast.w{border-color:var(--a3);color:var(--a3)}
.abtn{flex:1;font-family:'DM Mono',monospace;font-size:0.48rem;letter-spacing:1.5px;text-transform:uppercase;padding:10px;border-radius:2px;cursor:pointer;-webkit-appearance:none;background:transparent}

</style>
</head>
<body>

<div id="initScreen">
  <div><div class="logo">PRISM</div><div class="logo-tag">Depth Research Platform</div></div>
  <div class="logo-desc">Multi-algorithm depth: DFF/DFD bracketing (12 sharpness metrics), live monocular edge map, stereo disparity across all back cameras.</div>
  <div class="spin" id="spin"></div>
  <button class="ibtn" id="startBtn" onclick="startCam()">INITIALIZE CAMERA</button>
  <button class="ibtn sec" id="frontBtn" onclick="startCam(null,'user')">TRY FRONT CAMERA</button>
  <div class="err-box" id="errBox"><div class="err-title" id="errTitle"></div><span id="errMsg"></span></div>
  <div class="hint-box" id="hintBox"></div>
</div>

<div id="app">
  <div id="vWrap">
    <video id="video" autoplay muted playsinline webkit-playsinline></video>
    <canvas id="edgeOverlay"></canvas>
    <div class="flash" id="flash"></div>
    <div class="xhair"><div class="xc xtl"></div><div class="xc xtr"></div><div class="xc xbl"></div><div class="xc xbr"></div></div>
    <div class="vid-top">
      <div class="hud" id="hudL"><span class="ldot"></span>LIVE<br><span id="resT" style="color:var(--muted)">...</span></div>
      <div class="hud" id="hudR" style="text-align:right;font-size:0.4rem;line-height:2"></div>
    </div>
    <div id="scanHud"><div class="scan-inner" id="scanTxt">SCANNING 0/0</div><div class="scan-pbar"><div class="scan-pfill" id="scanPfill"></div></div></div>
    <div id="distHud"><span class="dist-num" id="distNum">--</span><span class="dist-lbl">distance</span><span class="dist-meth" id="distMeth"></span></div>
    <div class="vid-bot">
      <button class="iBtn" id="torchBtn" onclick="toggleTorch()">&#128294;</button>
      <div class="mpills">
        <div style="display:flex;gap:3px">
          <button class="mpill" id="mpphoto" onclick="setMode('photo')">PHOTO</button>
          <button class="mpill active" id="mpdfd" onclick="setMode('dfd')">DFD</button>
          <button class="mpill" id="mpedge" onclick="setMode('edge')">EDGE</button>
          <button class="mpill" id="mpstereo" onclick="setMode('stereo')">STEREO</button>
        </div>
        <button class="shutter" onclick="triggerCapture()"><div class="sh-in"></div></button>
      </div>
      <button class="iBtn" onclick="flipCam()">&#128260;</button>
    </div>
  </div>

  <div class="devbar" id="devBar"></div>
  <div class="warn" id="warn"></div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('ctrl')" id="tab-ctrl"><span class="ti">&#127917;</span>Controls</button>
    <button class="tab" onclick="showTab('depth')" id="tab-depth"><span class="ti">&#128256;</span>Depth</button>
    <button class="tab" onclick="showTab('stereo')" id="tab-stereo"><span class="ti">&#128065;</span>Stereo</button>
    <button class="tab" onclick="showTab('caps')" id="tab-caps"><span class="ti">&#128203;</span>Caps</button>
    <button class="tab" onclick="showTab('info')" id="tab-info"><span class="ti">&#9432;</span>Info</button>
  </div>

  <div id="panelWrap">

    <!-- CONTROLS -->
    <div class="tp active" id="panel-ctrl">
      <div id="cExposure"></div><div id="cFocus"></div>
      <div id="cWB"></div><div id="cImage"></div>
      <div id="cStream"></div><div id="cTorch"></div>
      <div style="margin-top:8px;display:flex;gap:5px">
        <button class="abtn" style="border:1px solid var(--border2);color:var(--text)" onclick="resetAll()">RESET</button>
        <button class="abtn" style="border:1px solid var(--a1);color:var(--a1)" onclick="refresh()">REFRESH</button>
        <button class="abtn" style="border:1px solid var(--a2);color:var(--a2)" onclick="stopCam()">STOP</button>
      </div>
    </div>

    <!-- DEPTH -->
    <div class="tp" id="panel-depth">

      <!-- Live distance -->
      <div class="dcrd">
        <div class="dch">Live Distance <span id="ldBig" style="font-family:'Syne',sans-serif;font-size:1.1rem;font-weight:800;color:var(--a1)">--</span></div>
        <div class="dcb">
          <div class="sg2">
            <div class="sc"><div class="sk">Focus API raw</div><div class="sv sm" id="dFocRaw">--</div></div>
            <div class="sc"><div class="sk">Unit detected</div><div class="sv sm" id="dFocUnit">--</div></div>
            <div class="sc"><div class="sk">Est. distance</div><div class="sv sm" id="dFocDist">--</div></div>
            <div class="sc"><div class="sk">Method</div><div class="sv sm" id="dMeth">--</div></div>
          </div>
        </div>
      </div>

      <!-- DFD/DFF Scan -->
      <div class="dcrd">
        <div class="dch">Bracket Depth Scan (DFF/DFD) <span id="dfdStat" style="font-size:0.38rem;color:var(--muted)">IDLE</span></div>
        <div class="dcb">

          <!-- Algorithm picker -->
          <div style="font-size:0.4rem;color:var(--muted);letter-spacing:1.5px;text-transform:uppercase;margin-bottom:5px">Sharpness Algorithm</div>
          <div class="algo-grid" id="algoGrid"></div>

          <!-- Params -->
          <div style="display:flex;gap:7px;flex-wrap:wrap">
            <div class="ctrl" style="flex:1;min-width:110px">
              <div class="ch2"><span class="cn">Steps</span><span class="cv" id="bStV">12</span></div>
              <input type="range" id="bSt" min="6" max="32" step="1" value="12" oninput="$('bStV').textContent=this.value">
            </div>
            <div class="ctrl" style="flex:1;min-width:110px">
              <div class="ch2"><span class="cn">Settle ms</span><span class="cv" id="bStlV">220</span></div>
              <input type="range" id="bStl" min="80" max="700" step="20" value="220" oninput="$('bStlV').textContent=this.value">
            </div>
            <div class="ctrl" style="flex:1;min-width:110px">
              <div class="ch2"><span class="cn">Grid W</span><span class="cv" id="bGWV">20</span></div>
              <input type="range" id="bGW" min="8" max="40" step="2" value="20" oninput="$('bGWV').textContent=this.value">
            </div>
            <div class="ctrl" style="flex:1;min-width:110px">
              <div class="ch2"><span class="cn">Grid H</span><span class="cv" id="bGHV">15</span></div>
              <input type="range" id="bGH" min="6" max="30" step="2" value="15" oninput="$('bGHV').textContent=this.value">
            </div>
          </div>

          <div class="pbar"><div class="pfill" id="dfdProg"></div></div>
          <canvas id="bracketCanvas" class="dc" height="90"></canvas>
          <canvas id="dfdMapCanvas" class="dc" height="160" style="margin-top:5px"></canvas>
          <div class="dleg">
            <span>NEAR</span>
            <div class="lbar" style="background:linear-gradient(to right,#ff2200,#ff8800,#ffff00,#00ff88,#0044ff)"></div>
            <span>FAR</span>
          </div>

          <!-- Per-algo sharpness curves -->
          <canvas id="curveCanvas" class="dc" height="80" style="margin-top:5px"></canvas>

          <div class="sg" style="margin-top:5px">
            <div class="sc"><div class="sk">Steps</div><div class="sv" id="bsS">--</div></div>
            <div class="sc"><div class="sk">Nearest</div><div class="sv sm" id="bsN">--</div></div>
            <div class="sc"><div class="sk">Farthest</div><div class="sv sm" id="bsF">--</div></div>
          </div>

          <div class="brow">
            <button class="db2" id="btnDFD" style="border:1px solid var(--a1);color:var(--a1)" onclick="runDFD()">RUN SCAN</button>
            <button class="db2" style="border:1px solid var(--a4);color:var(--a4)" onclick="saveDepthPNG()">SAVE PNG</button>
            <button class="db2" style="border:1px solid var(--a6);color:var(--a6)" onclick="saveDepthCSV()">SAVE CSV</button>
            <button class="db2" style="border:1px solid var(--border2);color:var(--muted)" onclick="clearDFD()">CLEAR</button>
          </div>
        </div>
      </div>

      <!-- Live Edge Map -->
      <div class="dcrd">
        <div class="dch">Live Edge Map (Monocular)
          <button class="mpill" id="btnEdgeLive" onclick="toggleEdgeLive()">START</button>
        </div>
        <div class="dcb">
          <canvas id="edgeMapCanvas" class="dc" height="130"></canvas>
          <div class="dleg" style="margin-top:4px">
            <span style="color:#ff3300">NEAR/SHARP</span>
            <div class="lbar" style="background:linear-gradient(to right,#ff3300,#ffaa00,#ffff00,#00cc88,#0055ff)"></div>
            <span style="color:#0055ff">FAR/BLURRY</span>
          </div>
          <div class="sg" style="margin-top:5px">
            <div class="sc"><div class="sk">Max gradient</div><div class="sv sm" id="emMax">--</div></div>
            <div class="sc"><div class="sk">Avg gradient</div><div class="sv sm" id="emAvg">--</div></div>
            <div class="sc"><div class="sk">Center depth</div><div class="sv sm" id="emCtr">--</div></div>
          </div>
          <div style="margin-top:6px;font-size:0.44rem;color:var(--muted);line-height:1.9">
            Sobel operator per 32x24 grid. Works on ALL cameras. Overlay also shown on viewfinder. High gradient (hot) = sharp/near; low (cool) = blurry/far.
          </div>
        </div>
      </div>

      <!-- 3D Point Cloud -->
      <div class="dcrd">
        <div class="dch">3D Point Cloud <span id="pcStat" style="font-size:0.38rem;color:var(--muted)">Run scan first</span></div>
        <div class="dcb">
          <canvas id="pcCanvas" class="dc" height="200"></canvas>
          <div class="brow" style="margin-top:5px">
            <button class="db2" style="border:1px solid var(--a4);color:var(--a4)" onclick="renderPC()">RENDER 3D</button>
            <button class="db2" id="btnPCRot" style="border:1px solid var(--border2);color:var(--muted)" onclick="togglePCRot()">AUTO ROTATE</button>
            <button class="db2" style="border:1px solid var(--border2);color:var(--muted)" onclick="savePC()">SAVE PNG</button>
          </div>
        </div>
      </div>
    </div>

    <!-- STEREO -->
    <div class="tp" id="panel-stereo">
      <div class="dcrd">
        <div class="dch">Stereo Camera Selector</div>
        <div class="dcb">
          <div style="font-size:0.44rem;color:var(--muted);line-height:1.9;margin-bottom:8px">
            All detected cameras listed. Select any two. For best results use cameras with different physical positions (e.g. main + ultrawide on Android). The app captures sequentially from each.
          </div>
          <div style="display:flex;gap:5px;margin-bottom:8px">
            <div style="flex:1">
              <div style="font-size:0.4rem;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:1px">Left / Cam A</div>
              <select id="camL" style="font-size:0.48rem"></select>
            </div>
            <div style="flex:1">
              <div style="font-size:0.4rem;color:var(--muted);margin-bottom:3px;text-transform:uppercase;letter-spacing:1px">Right / Cam B</div>
              <select id="camR" style="font-size:0.48rem"></select>
            </div>
          </div>
          <div class="ctrl" style="margin-bottom:8px">
            <div class="ch2"><span class="cn">Block size (SAD)</span><span class="cv" id="sadBV">8</span></div>
            <input type="range" id="sadB" min="4" max="24" step="2" value="8" oninput="$('sadBV').textContent=this.value">
          </div>
          <div class="ctrl" style="margin-bottom:8px">
            <div class="ch2"><span class="cn">Max disparity</span><span class="cv" id="maxDV">64</span></div>
            <input type="range" id="maxD" min="16" max="128" step="8" value="64" oninput="$('maxDV').textContent=this.value">
          </div>
          <div class="brow">
            <button class="db2" id="btnStereo" style="border:1px solid var(--a5);color:var(--a5)" onclick="runStereo()">CAPTURE &amp; COMPUTE</button>
          </div>
          <div class="sg2" style="margin-top:7px">
            <div class="sc"><div class="sk">Status</div><div class="sv sm" id="stereoStat">Idle</div></div>
            <div class="sc"><div class="sk">Resolution</div><div class="sv sm" id="stereoRes">--</div></div>
          </div>
          <!-- Side by side preview -->
          <canvas id="stereoPreview" class="dc" height="100" style="margin-top:6px"></canvas>
          <!-- Disparity map -->
          <canvas id="stereoDisp" class="dc" height="140" style="margin-top:5px"></canvas>
          <div class="dleg" style="margin-top:4px">
            <span>HIGH DISP (near)</span>
            <div class="lbar" style="background:linear-gradient(to right,#ff2200,#00ff88,#0044ff)"></div>
            <span>LOW DISP (far)</span>
          </div>
          <!-- Depth from disparity -->
          <canvas id="stereoDepth" class="dc" height="140" style="margin-top:5px"></canvas>
          <div class="brow" style="margin-top:5px">
            <button class="db2" style="border:1px solid var(--a4);color:var(--a4)" onclick="saveStereoDisp()">SAVE DISPARITY</button>
            <button class="db2" style="border:1px solid var(--border2);color:var(--muted)" onclick="clearStereo()">CLEAR</button>
          </div>
        </div>
      </div>
    </div>

    <!-- CAPS -->
    <div class="tp" id="panel-caps">
      <div class="sec">
        <div class="sh" onclick="togS(this)"><div class="sl"><span class="st">All Capabilities &amp; Ranges</span></div><span class="sch">&#9662;</span></div>
        <div class="sb"><table class="cap-tbl"><thead><tr><th>Property</th><th>Range / Values</th></tr></thead><tbody id="capBody"></tbody></table></div>
      </div>
    </div>

    <!-- INFO -->
    <div class="tp" id="panel-info">
      <div class="igrid" id="infoGrid"></div>
      <div style="margin-top:6px" class="sec">
        <div class="sh" onclick="togS(this)"><div class="sl"><span class="st">Current Settings</span></div><span class="sch">&#9662;</span></div>
        <div class="sb"><table class="cap-tbl"><thead><tr><th>Setting</th><th>Value</th></tr></thead><tbody id="setBody"></tbody></table></div>
      </div>
    </div>
  </div>
</div>
<div class="toast" id="toast"></div>
<canvas id="capCanvas" style="display:none"></canvas>
<canvas id="wkCanvas" style="display:none"></canvas>

<script>

'use strict';
var stream=null,track=null,ic=null,caps={},sets={};
var torchOn=false,facing='environment',devs=[];
var captureMode='dfd';
var curAlgo='laplacian';
var edgeLiveOn=false,edgeRAF=null;
var dfdRunning=false;
var pcRotating=false,pcRotRAF=null,pcAngle=0;
var lastDFD=null;
var lastStereo=null;
var distTimer=null;
var streamA=null,streamB=null;

function $(id){return document.getElementById(id);}
function sleep(ms){return new Promise(function(r){setTimeout(r,ms);});}

/* All sharpness algorithms */
var ALGOS=[
  {id:'laplacian',  name:'Laplacian Var',   tag:'LAP'},
  {id:'sobel',      name:'Sobel RMS',        tag:'SOB'},
  {id:'tenengrad',  name:'Tenengrad',        tag:'TEN'},
  {id:'brenner',    name:'Brenner',          tag:'BRE'},
  {id:'variance',   name:'Variance',         tag:'VAR'},
  {id:'normvar',    name:'Norm Variance',    tag:'NVR'},
  {id:'energy',     name:'Energy of Lap',    tag:'ELO'},
  {id:'vollathF4',  name:"Vollath F4",       tag:'VF4'},
  {id:'vollathF6',  name:"Vollath F6",       tag:'VF6'},
  {id:'smd',        name:'SMD',              tag:'SMD'},
  {id:'steerable',  name:'Steerable Filt',   tag:'STR'},
  {id:'structtens', name:'Struct Tensor',    tag:'STT'},
];

function buildAlgoGrid(){
  var g=$('algoGrid');g.innerHTML='';
  ALGOS.forEach(function(a){
    var b=document.createElement('button');
    b.className='atab'+(a.id===curAlgo?' active':'');
    b.id='algo_'+a.id;
    b.innerHTML='<b>'+a.tag+'</b><br>'+a.name;
    b.onclick=(function(aid){return function(){setAlgo(aid);};})(a.id);
    g.appendChild(b);
  });
}

function setAlgo(id){
  curAlgo=id;
  document.querySelectorAll('.atab').forEach(function(b){b.classList.remove('active');});
  var el=$('algo_'+id);if(el)el.classList.add('active');
}

/* VH */
function setVH(){
  var vw=window.innerWidth,vh=window.innerHeight;
  $('vWrap').style.height=(vw>vh?Math.round(vh*.48):Math.round(vh*.34))+'px';
  /* Defer canvas resize so browser layout has settled */
  requestAnimationFrame(function(){
    var eo=$('edgeOverlay');
    var w=$('vWrap').offsetWidth||vw;
    var h=$('vWrap').offsetHeight||(vw>vh?Math.round(vh*.48):Math.round(vh*.34));
    if(w>0&&h>0){eo.width=w;eo.height=h;}
  });
}
window.addEventListener('load',function(){
  buildAlgoGrid();setVH();
  if(!window.isSecureContext){showInitErr('Insecure Context','Needs HTTPS or localhost.','Android: http://localhost in Chrome\niOS: localhost or https://');$('startBtn').disabled=true;return;}
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){showInitErr('Camera API Unavailable','Not supported.','Chrome/Android or Safari 14.3+/iOS\nMust be localhost or HTTPS');$('startBtn').disabled=true;}
});
window.addEventListener('resize',function(){setVH();});
window.addEventListener('orientationchange',function(){setTimeout(setVH,350);});

/* CAMERA */
async function startCam(deviceId,f){
  var btn=$('startBtn');btn.disabled=true;btn.textContent='REQUESTING...';
  $('spin').style.display='block';hideErr();
  var fc=f||facing;
  try{
    if(stream)stream.getTracks().forEach(function(t){t.stop();});
    var s;
    if(deviceId){
      s=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:deviceId},width:{ideal:3840},height:{ideal:2160}},audio:false});
    }else{
      try{s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{exact:fc},width:{ideal:3840},height:{ideal:2160}},audio:false});}
      catch(e1){
        try{s=await navigator.mediaDevices.getUserMedia({video:{facingMode:{ideal:fc},width:{ideal:1920},height:{ideal:1080}},audio:false});}
        catch(e2){s=await navigator.mediaDevices.getUserMedia({video:true,audio:false});}
      }
    }
    stream=s;
    var vid=$('video');vid.srcObject=s;
    await new Promise(function(r){vid.onloadedmetadata=r;setTimeout(r,3500);});
    await vid.play().catch(function(){});
    track=stream.getVideoTracks()[0];
    if(track.getSettings)facing=track.getSettings().facingMode||fc;
    try{if('ImageCapture'in window)ic=new ImageCapture(track);}catch(e){ic=null;}
    await loadDevs();
    readCaps();buildAll();startOv();startDistMonitor();
    $('initScreen').style.display='none';
    $('app').style.display='flex';$('app').style.flexDirection='column';
    setVH();updateTorchBtn();
    showToast(devs.length+' camera(s) found','ok');
  }catch(e){handleErr(e);btn.disabled=false;btn.textContent='TRY AGAIN';}
  $('spin').style.display='none';
}

function handleErr(e){
  var title='Error',msg=e.message||String(e),hint='';
  if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError'){
    title='Permission Denied';msg='Camera access blocked.';
    hint='Android Chrome:\n  Lock icon > Site Settings > Camera > Allow\n\niOS Safari:\n  Settings > Safari > Camera > Allow\n\nReload after granting.';
    $('frontBtn').style.display='block';
  }else if(e.name==='NotFoundError'){title='No Camera Found';msg='No camera detected.';}
  else if(e.name==='NotReadableError'||e.name==='TrackStartError'){title='Camera Busy';msg='Close other apps using camera.';}
  else if(e.name==='OverconstrainedError'){
    navigator.mediaDevices.getUserMedia({video:true,audio:false}).then(function(s){
      stream=s;$('video').srcObject=s;track=s.getVideoTracks()[0];
      readCaps();buildAll();startOv();startDistMonitor();
      $('initScreen').style.display='none';$('app').style.display='flex';$('app').style.flexDirection='column';
      loadDevs();
    }).catch(function(e2){handleErr(e2);});return;
  }
  showInitErr(title,msg,hint);
}

async function loadDevs(){
  try{
    /* enumerateDevices AFTER getUserMedia to get real labels */
    var all=await navigator.mediaDevices.enumerateDevices();
    devs=all.filter(function(d){return d.kind==='videoinput';});
    var bar=$('devBar');bar.innerHTML='';
    var cur=track&&track.getSettings?track.getSettings().deviceId:null;
    devs.forEach(function(d,i){
      var lbl=d.label||('Camera '+(i+1));
      var ll=lbl.toLowerCase();
      /* Android labels: "camera2 0, facing back", "camera2 1, facing back"
         iOS: "Back Camera", "Front Camera", "Back Ultra Wide Camera"
         Generic: "back", "rear", "front" etc */
      var fg='';
      if(ll.indexOf('back')>=0||ll.indexOf('rear')>=0||ll.indexOf('environment')>=0||
         ll.indexOf('wide')>=0||ll.indexOf('tele')>=0||ll.indexOf('ultra')>=0||
         ll.indexOf('main')>=0){fg='BACK';}
      else if(ll.indexOf('front')>=0||ll.indexOf('user')>=0||
              ll.indexOf('selfie')>=0||ll.indexOf('facetime')>=0){fg='FRONT';}
      /* Android "camera2 N, facing back" */
      else if(ll.match(/facing back/)){fg='BACK';}
      else if(ll.match(/facing front/)){fg='FRONT';}
      var b=document.createElement('button');
      b.className='dbtn'+(d.deviceId===cur?' active':'');
      b.dataset.facing=fg;
      b.innerHTML=lbl+'<span class="dfacing">'+(fg||('CAM '+(i+1)))+'</span>';
      b.onclick=(function(did){return function(){startCam(did);};})(d.deviceId);
      bar.appendChild(b);
    });
    /* Also populate stereo selects */
    populateStereoSels();
  }catch(e){console.warn('loadDevs',e);}
}

function populateStereoSels(){
  function isBack(d){
    var ll=(d.label||'').toLowerCase();
    return ll.indexOf('back')>=0||ll.indexOf('rear')>=0||ll.indexOf('environment')>=0||
           ll.indexOf('wide')>=0||ll.indexOf('tele')>=0||ll.indexOf('ultra')>=0||
           ll.indexOf('main')>=0||(ll.indexOf('facing')>=0&&ll.indexOf('back')>=0);}
  function isFront(d){var ll=(d.label||'').toLowerCase();return ll.indexOf('front')>=0||ll.indexOf('user')>=0||ll.indexOf('selfie')>=0;}
  var backCams=devs.filter(isBack);
  var defL=backCams.length>=1?backCams[0].deviceId:(devs[0]?devs[0].deviceId:'');
  var defR=backCams.length>=2?backCams[1].deviceId:(devs[1]?devs[1].deviceId:'');
  [$('camL'),$('camR')].forEach(function(sel,si){
    sel.innerHTML='';
    var def=si===0?defL:defR;
    devs.forEach(function(d,i){
      var o=document.createElement('option');
      o.value=d.deviceId;
      var tag=isBack(d)?'[B] ':isFront(d)?'[F] ':'';
      o.textContent=tag+(d.label||('Camera '+(i+1)));
      if(d.deviceId===def)o.selected=true;
      sel.appendChild(o);
    });
  });
  $('btnStereo').style.opacity=devs.length>=2?'1':'0.4';
  $('stereoStat').textContent=backCams.length+' back cam(s) found, '+devs.length+' total';
}

function flipCam(){facing=facing==='environment'?'user':'environment';startCam(null,facing);}

function stopCam(){
  clearInterval(distTimer);stopEdgeLive();
  if(pcRotRAF){cancelAnimationFrame(pcRotRAF);pcRotRAF=null;}
  [stream,streamA,streamB].forEach(function(s){if(s)s.getTracks().forEach(function(t){t.stop();});});
  $('video').srcObject=null;stream=track=ic=streamA=streamB=null;
  $('app').style.display='none';$('initScreen').style.display='flex';
  $('startBtn').disabled=false;$('startBtn').textContent='INITIALIZE CAMERA';
}

function readCaps(){
  if(!track)return;
  caps=track.getCapabilities?track.getCapabilities():{};
  sets=track.getSettings?track.getSettings():{};
}

async function applyC(obj){
  if(!track)return;
  try{await track.applyConstraints({advanced:[obj]});sets=track.getSettings();updHUD();}
  catch(e){showWarn('Cannot apply ['+Object.keys(obj).join(',')+'] - '+e.message);}
}
function showWarn(m){var w=$('warn');w.textContent=m;w.style.display='block';clearTimeout(showWarn._t);showWarn._t=setTimeout(function(){w.style.display='none';},5000);}

/* CONTROLS */
function buildAll(){buildCtrl();buildCapsTab();buildInfoTab();}

function buildCtrl(){
  buildSec('cExposure','Exposure','LIVE','a1',[
    mkSel('expMode','Exposure Mode',caps.exposureMode,sets.exposureMode,function(v){applyC({exposureMode:v});},!!caps.exposureMode),
    mkR('expTime','Exposure Time',caps.exposureTime,sets.exposureTime,'us',function(v){applyC({exposureTime:v});},!!caps.exposureTime),
    mkR('expComp','EV Compensation',caps.exposureCompensation||{min:-3,max:3,step:.1},sets.exposureCompensation!=null?sets.exposureCompensation:0,'EV',function(v){applyC({exposureCompensation:v});},!!caps.exposureCompensation),
    mkR('iso','ISO',caps.iso,sets.iso,'',function(v){applyC({iso:v});},!!caps.iso),
  ]);
  buildSec('cFocus','Focus','LIVE','a1',[
    mkSel('focMode','Focus Mode',caps.focusMode,sets.focusMode,function(v){applyC({focusMode:v});var r=$('focDist');if(r)r.disabled=(v!=='manual');},!!caps.focusMode),
    mkR('focDist','Focus Distance',caps.focusDistance,sets.focusDistance,'m',function(v){applyC({focusDistance:v});updateFocusDist(v);},!!caps.focusDistance),
  ]);
  buildSec('cWB','White Balance','LIVE','a1',[
    mkSel('wbMode','WB Mode',caps.whiteBalanceMode,sets.whiteBalanceMode,function(v){applyC({whiteBalanceMode:v});},!!caps.whiteBalanceMode),
    mkR('colTemp','Color Temp',caps.colorTemperature,sets.colorTemperature,'K',function(v){applyC({colorTemperature:v});},!!caps.colorTemperature),
  ]);
  buildSec('cImage','Image Adjustments','LIVE','a1',[
    mkR('bri','Brightness',caps.brightness,sets.brightness,'%',function(v){applyC({brightness:v});},!!caps.brightness),
    mkR('con','Contrast',caps.contrast,sets.contrast,'%',function(v){applyC({contrast:v});},!!caps.contrast),
    mkR('sat','Saturation',caps.saturation,sets.saturation,'%',function(v){applyC({saturation:v});},!!caps.saturation),
    mkR('shrp','Sharpness',caps.sharpness,sets.sharpness,'',function(v){applyC({sharpness:v});},!!caps.sharpness),
    mkR('pan2','Pan',caps.pan,sets.pan,'deg',function(v){applyC({pan:v});},!!caps.pan),
    mkR('tilt2','Tilt',caps.tilt,sets.tilt,'deg',function(v){applyC({tilt:v});},!!caps.tilt),
  ]);
  buildSec('cStream','Resolution & FPS',null,null,[
    mkR('rW','Width',caps.width,sets.width,'px',function(v){track.applyConstraints({width:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.width),
    mkR('rH','Height',caps.height,sets.height,'px',function(v){track.applyConstraints({height:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.height),
    mkR('fps2','Frame Rate',caps.frameRate,sets.frameRate,'fps',function(v){track.applyConstraints({frameRate:{ideal:v}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.frameRate),
    mkSel('rsMode','Resize Mode',caps.resizeMode,sets.resizeMode,function(v){track.applyConstraints({resizeMode:v}).catch(function(){});},!!caps.resizeMode),
  ]);
  buildSec('cTorch','Torch & Zoom','LIVE','a1',[
    mkTog('tTog','Torch',sets.torch||false,function(v){torchOn=v;applyC({torch:v});updateTorchBtn();},!!caps.torch),
    mkR('zoom2','Zoom',caps.zoom,sets.zoom,'x',function(v){applyC({zoom:v});},!!caps.zoom),
  ]);
}

function buildSec(mnt,title,tag,col,items){
  var el=$(mnt);el.innerHTML='';
  var sec=document.createElement('div');sec.className='sec';
  var head=document.createElement('div');head.className='sh';head.onclick=function(){togS(head);};
  var left=document.createElement('div');left.className='sl';
  var t=document.createElement('span');t.className='st';t.textContent=title;left.appendChild(t);
  if(tag){var tg=document.createElement('span');tg.className='stag'+(col?' '+col:'');tg.textContent=tag;left.appendChild(tg);}
  var ch=document.createElement('span');ch.className='sch';ch.textContent='\u25be';
  head.appendChild(left);head.appendChild(ch);
  var body=document.createElement('div');body.className='sb';
  items.forEach(function(i){body.appendChild(i);});
  sec.appendChild(head);sec.appendChild(body);el.appendChild(sec);
}

function fmtV(v,u){
  if(typeof v!=='number')return '--';
  if(u==='us')return v>=1000?(v/1000).toFixed(2)+'ms':Math.round(v)+'\u00b5s';
  if(u==='%')return Math.round(v)+'%';
  if(u==='deg')return Math.round(v)+'\u00b0';
  if(u==='px')return Math.round(v)+'px';
  if(u==='fps')return v.toFixed(1)+'fps';
  if(u==='x')return v.toFixed(2)+'\u00d7';
  if(u==='m')return v.toFixed(4)+'m';
  if(u==='EV')return(v>=0?'+':'')+v.toFixed(2)+'EV';
  if(u==='K')return Math.round(v)+'K';
  return Number.isInteger(v)?v+(u||''):v.toFixed(2)+(u||'');
}

function mkR(id,lbl,cap,cur,u,fn,sup){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var hd=document.createElement('div');hd.className='ch2';
  var nm=document.createElement('span');nm.className='cn';nm.textContent=lbl;hd.appendChild(nm);
  if(!sup){var b=document.createElement('span');b.className='nab';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;}
  var mn=cap&&cap.min!=null?cap.min:0,mx=cap&&cap.max!=null?cap.max:100,st=cap&&cap.step!=null?cap.step:((mx-mn)/100)||1;
  var vl=document.createElement('span');vl.className='cv';vl.id=id+'_v';vl.textContent=fmtV(cur!=null?cur:mn,u);hd.appendChild(vl);wrap.appendChild(hd);
  var ri=document.createElement('div');ri.className='cri';
  ri.innerHTML='<span>'+fmtV(mn,u)+'</span><span>min-max</span><span>'+fmtV(mx,u)+'</span>';
  wrap.appendChild(ri);
  var r=document.createElement('input');r.type='range';r.id=id;r.min=mn;r.max=mx;r.step=st;r.value=cur!=null?cur:mn;
  r.addEventListener('input',function(){var v=parseFloat(r.value);vl.textContent=fmtV(v,u);fn(v);});
  wrap.appendChild(r);return wrap;
}
function mkSel(id,lbl,opts,cur,fn,sup){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var hd=document.createElement('div');hd.className='ch2';
  var nm=document.createElement('span');nm.className='cn';nm.textContent=lbl;hd.appendChild(nm);
  if(!sup||!opts||!opts.length){var b=document.createElement('span');b.className='nab';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;}
  wrap.appendChild(hd);
  var sel=document.createElement('select');sel.id=id;
  opts.forEach(function(o){var opt=document.createElement('option');opt.value=o;opt.textContent=o;if(o===cur)opt.selected=true;sel.appendChild(opt);});
  sel.addEventListener('change',function(){fn(sel.value);});
  wrap.appendChild(sel);return wrap;
}
function mkTog(id,lbl,chk,fn,sup){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var row=document.createElement('div');row.className='trow';
  var l=document.createElement('span');l.className='tn';l.textContent=lbl;row.appendChild(l);
  if(!sup){var b=document.createElement('span');b.className='nab';b.textContent='NOT SUPPORTED';row.appendChild(b);wrap.appendChild(row);return wrap;}
  var tog=document.createElement('label');tog.className='tog';
  var inp=document.createElement('input');inp.type='checkbox';inp.checked=chk;inp.id=id;
  inp.addEventListener('change',function(){fn(inp.checked);});
  var tr=document.createElement('span');tr.className='ttr';
  tog.appendChild(inp);tog.appendChild(tr);row.appendChild(tog);wrap.appendChild(row);return wrap;
}

/* CAPS TABLE */
var ALLP=['width','height','frameRate','aspectRatio','facingMode','resizeMode','zoom','torch',
  'focusMode','focusDistance','exposureMode','exposureTime','exposureCompensation','iso',
  'whiteBalanceMode','colorTemperature','brightness','contrast','saturation','sharpness',
  'pan','tilt','channelCount','latency','sampleRate'];
function buildCapsTab(){
  var body=$('capBody');body.innerHTML='';var done={};
  function rr(k,v){
    done[k]=true;var tr=document.createElement('tr');
    var td1=document.createElement('td');td1.textContent=k;tr.appendChild(td1);
    var td2=document.createElement('td');
    if(v===undefined||v===null){td2.innerHTML='<span class="no">not reported</span>';}
    else if(Array.isArray(v)){td2.innerHTML=v.map(function(x){return '<span class="vc">'+x+'</span>';}).join('');}
    else if(typeof v==='object'&&('min'in v||'max'in v)){
      var s='';if('min'in v&&'max'in v)s+='min: '+fmtCapV(k,v.min)+'&nbsp;max: '+fmtCapV(k,v.max);
      if('step'in v)s+='&nbsp;step: '+v.step;td2.innerHTML='<span class="ok">'+s+'</span>';
    }else if(typeof v==='boolean'){td2.innerHTML=v?'<span class="ok">true</span>':'<span class="no">false</span>';}
    else{td2.innerHTML='<span class="ok">'+v+'</span>';}
    tr.appendChild(td2);body.appendChild(tr);
  }
  ALLP.forEach(function(k){rr(k,caps[k]);});
  Object.keys(caps).forEach(function(k){if(!done[k])rr(k+' *',caps[k]);});
}
function fmtCapV(k,v){
  if(typeof v!=='number')return String(v);
  var u={width:'px',height:'px',frameRate:'fps',zoom:'x',focusDistance:'m',exposureTime:'us',colorTemperature:'K',pan:'deg',tilt:'deg',exposureCompensation:'EV'};
  return fmtV(v,u[k]||'');
}
function buildInfoTab(){
  var s=track.getSettings();var g=$('infoGrid');g.innerHTML='';
  var dl='Unknown';for(var i=0;i<devs.length;i++){if(devs[i].deviceId===s.deviceId){dl=devs[i].label||'Cam '+(i+1);break;}}
  var rows=[
    ['Device',dl,true],['Facing',s.facingMode||'--',false],
    ['Resolution',(s.width||'?')+'x'+(s.height||'?'),false],
    ['FPS',s.frameRate?(+s.frameRate).toFixed(2)+'fps':'--',false],
    ['Exp Mode',s.exposureMode||'--',false],['Focus Mode',s.focusMode||'--',false],
    ['WB Mode',s.whiteBalanceMode||'--',false],['ISO',s.iso!=null?s.iso:'--',false],
    ['EV',s.exposureCompensation!=null?s.exposureCompensation+'EV':'--',false],
    ['Zoom',s.zoom!=null?s.zoom+'x':'--',false],['Torch',s.torch!=null?(s.torch?'ON':'OFF'):'--',false],
    ['focusDist cap',caps.focusDistance?'YES: '+fmtCapV('focusDistance',caps.focusDistance.min)+' to '+fmtCapV('focusDistance',caps.focusDistance.max):'NOT REPORTED',true],
    ['Cameras found',devs.length.toString(),false],
    ['Device ID',(s.deviceId||'--').slice(0,20),true],
  ];
  rows.forEach(function(row){
    var c=document.createElement('div');c.className='ic'+(row[2]?' full':'');
    c.innerHTML='<div class="ik">'+row[0]+'</div><div class="iv">'+row[1]+'</div>';g.appendChild(c);
  });
  var sb=$('setBody');sb.innerHTML='';
  Object.entries(s).forEach(function(p){
    var tr=document.createElement('tr');var fmt=typeof p[1]==='number'&&p[1]%1!==0?p[1].toFixed(6):String(p[1]);
    tr.innerHTML='<td>'+p[0]+'</td><td style="color:var(--a1)">'+fmt+'</td>';sb.appendChild(tr);
  });
}

/* OVERLAY */
var ovT=null;
function startOv(){
  clearInterval(ovT);
  ovT=setInterval(function(){
    if(!track)return;var s=track.getSettings();
    $('resT').textContent=(s.width||'?')+'x'+(s.height||'?')+' '+(+(s.frameRate||0)).toFixed(1)+'fps';
    updHUD();
  },1500);
}
function updHUD(){
  if(!track)return;var s=track.getSettings();var l=[];
  if(s.facingMode)l.push(s.facingMode.toUpperCase());
  if(s.focusMode)l.push('F:'+s.focusMode.slice(0,5));
  if(s.iso!=null)l.push('ISO'+s.iso);
  if(s.zoom!=null&&s.zoom!==1)l.push((+s.zoom).toFixed(1)+'x');
  $('hudR').innerHTML=l.join('<br>');
}

/* DISTANCE MONITORING */
function startDistMonitor(){
  clearInterval(distTimer);
  distTimer=setInterval(function(){
    if(!track)return;var s=track.getSettings();
    var dist=null,meth='--';
    if(s.focusDistance!=null){
      var fd=+s.focusDistance,fc=caps.focusDistance;
      $('dFocRaw').textContent=fd.toFixed(4);
      if(fc){
        if(fc.max<=1.0){dist=fd<0.005?null:(0.05+fd*14);meth='norm->m';}
        else if(fc.max>80){dist=fd>0.005?1/fd:null;meth='diop->m';}
        else{dist=fd>0?fd:null;meth='direct m';}
        $('dFocUnit').textContent=fc.max<=1.0?'0-1 norm':fc.max>80?'diopters':'meters';
      }else{dist=fd>0?fd:null;meth='raw';}
      $('dFocDist').textContent=dist?fmtDist(dist):'inf/unknown';
    }else{$('dFocRaw').textContent='N/A';$('dFocUnit').textContent='N/A';$('dFocDist').textContent='N/A';}
    $('dMeth').textContent=meth;
    setDistDisp(dist,meth);
  },600);
}
function updateFocusDist(fd){
  var fc=caps.focusDistance,dist=null,meth='manual';
  if(fc){if(fc.max<=1.0){dist=0.05+fd*14;meth='norm->m';}else if(fc.max>80){dist=fd>0.005?1/fd:null;meth='diop->m';}else{dist=fd>0?fd:null;meth='direct m';}}
  setDistDisp(dist,meth);
}
function setDistDisp(d,m){
  $('dMeth').textContent=m;
  if(d!=null&&d>0&&d<300){var ds=fmtDist(d);$('distNum').textContent=ds;$('ldBig').textContent=ds;$('distMeth').textContent=m;$('distHud').style.display='block';}
  else{$('ldBig').textContent='--';$('distHud').style.display='none';}
}
function fmtDist(d){
  if(d==null||isNaN(d)||d<=0)return '--';
  if(d<0.01)return(d*1000).toFixed(1)+'mm';
  if(d<1)return(d*100).toFixed(1)+'cm';
  if(d>200)return '>200m';
  return d.toFixed(2)+'m';
}

/* CAPTURE MODES */
function setMode(m){
  captureMode=m;document.querySelectorAll('.mpill').forEach(function(b){b.classList.remove('active');});
  $('mp'+m).classList.add('active');
  if(m!=='edge')stopEdgeLive();
  if(m==='edge'){startEdgeLive();showTab('depth');}
}
async function triggerCapture(){
  if(captureMode==='dfd'){runDFD();showTab('depth');}
  else if(captureMode==='edge'){toggleEdgeLive();showTab('depth');}
  else if(captureMode==='stereo'){runStereo();showTab('stereo');}
  else{snapPhoto();}
}
async function snapPhoto(){
  var fl=$('flash');fl.style.animation='none';fl.style.opacity='0';void fl.offsetWidth;fl.style.animation='fOut 0.4s ease-out forwards';
  try{
    var blob=null;
    if(ic){try{blob=await ic.takePhoto();}catch(e){blob=null;}}
    if(!blob){var v=$('video'),c=$('capCanvas');c.width=v.videoWidth;c.height=v.videoHeight;c.getContext('2d').drawImage(v,0,0);blob=await new Promise(function(r){c.toBlob(r,'image/jpeg',.97);});}
    if(blob){var url=URL.createObjectURL(blob);var a=document.createElement('a');a.href=url;a.download='prism-'+Date.now()+'.jpg';document.body.appendChild(a);a.click();document.body.removeChild(a);URL.revokeObjectURL(url);showToast('Photo saved','ok');}
  }catch(e){showToast('Capture failed','err');}
}

/* ====== SHARPNESS OPERATORS ====== */
function gray(d,W,x,y){var i=(y*W+x)*4;return .299*d[i]+.587*d[i+1]+.114*d[i+2];}

function computeSharp(d,W,x0,y0,x1,y1,algo){
  var N=(x1-x0)*(y1-y0);if(N<4)return 0;
  switch(algo){
    case 'laplacian': return lapVar(d,W,x0,y0,x1,y1);
    case 'sobel':     return sobelRMS(d,W,x0,y0,x1,y1);
    case 'tenengrad': return tenengrad(d,W,x0,y0,x1,y1);
    case 'brenner':   return brenner(d,W,x0,y0,x1,y1);
    case 'variance':  return variance(d,W,x0,y0,x1,y1);
    case 'normvar':   return normVariance(d,W,x0,y0,x1,y1);
    case 'energy':    return energyLap(d,W,x0,y0,x1,y1);
    case 'vollathF4': return vollathF4(d,W,x0,y0,x1,y1);
    case 'vollathF6': return vollathF6(d,W,x0,y0,x1,y1);
    case 'smd':       return smd(d,W,x0,y0,x1,y1);
    case 'steerable': return steerable(d,W,x0,y0,x1,y1);
    case 'structtens':return structTens(d,W,x0,y0,x1,y1);
    default:          return lapVar(d,W,x0,y0,x1,y1);
  }
}

/* 1. Laplacian Variance */
function lapVar(d,W,x0,y0,x1,y1){
  var s=0,s2=0,n=0;
  for(var y=y0+1;y<y1-1;y++){for(var x=x0+1;x<x1-1;x++){
    var v=4*gray(d,W,x,y)-gray(d,W,x-1,y)-gray(d,W,x+1,y)-gray(d,W,x,y-1)-gray(d,W,x,y+1);
    s+=v;s2+=v*v;n++;
  }}
  return n?(s2/n-(s/n)*(s/n)):0;
}

/* 2. Sobel RMS */
function sobelRMS(d,W,x0,y0,x1,y1){
  var s=0,n=0;
  for(var sy=y0+1;sy<y1-1;sy++){for(var sx=x0+1;sx<x1-1;sx++){
    var ggx=gray(d,W,sx+1,sy-1)+2*gray(d,W,sx+1,sy)+gray(d,W,sx+1,sy+1)-gray(d,W,sx-1,sy-1)-2*gray(d,W,sx-1,sy)-gray(d,W,sx-1,sy+1);
    var ggy=gray(d,W,sx-1,sy+1)+2*gray(d,W,sx,sy+1)+gray(d,W,sx+1,sy+1)-gray(d,W,sx-1,sy-1)-2*gray(d,W,sx,sy-1)-gray(d,W,sx+1,sy-1);
    s+=ggx*ggx+ggy*ggy;n++;
  }}
  return n?Math.sqrt(s/n):0;
}

/* 3. Tenengrad (threshold gradient sum) */
function tenengrad(d,W,x0,y0,x1,y1){
  var T=10*10,s=0;/* threshold on squared gradient */
  for(var sy=y0+1;sy<y1-1;sy++){for(var sx=x0+1;sx<x1-1;sx++){
    var ggx=gray(d,W,sx+1,sy-1)+2*gray(d,W,sx+1,sy)+gray(d,W,sx+1,sy+1)-gray(d,W,sx-1,sy-1)-2*gray(d,W,sx-1,sy)-gray(d,W,sx-1,sy+1);
    var ggy=gray(d,W,sx-1,sy+1)+2*gray(d,W,sx,sy+1)+gray(d,W,sx+1,sy+1)-gray(d,W,sx-1,sy-1)-2*gray(d,W,sx,sy-1)-gray(d,W,sx+1,sy-1);
    var g2=ggx*ggx+ggy*ggy;if(g2>T)s+=g2;
  }}
  return s;
}

/* 4. Brenner (horizontal second difference) */
function brenner(d,W,x0,y0,x1,y1){
  var s=0;
  for(var y=y0;y<y1;y++){for(var x=x0;x<x1-2;x++){
    var v=gray(d,W,x+2,y)-gray(d,W,x,y);s+=v*v;
  }}
  return s;
}

/* 5. Variance of pixel intensities */
function variance(d,W,x0,y0,x1,y1){
  var s=0,s2=0,n=0;
  for(var y=y0;y<y1;y++){for(var x=x0;x<x1;x++){var v=gray(d,W,x,y);s+=v;s2+=v*v;n++;}}
  return n?(s2/n-(s/n)*(s/n)):0;
}

/* 6. Normalized Variance */
function normVariance(d,W,x0,y0,x1,y1){
  var s=0,s2=0,n=0;
  for(var y=y0;y<y1;y++){for(var x=x0;x<x1;x++){var v=gray(d,W,x,y);s+=v;s2+=v*v;n++;}}
  if(!n)return 0;var mean=s/n;return mean>0?(s2/n-(mean*mean))/mean:0;
}

/* 7. Energy of Laplacian */
function energyLap(d,W,x0,y0,x1,y1){
  var s=0;
  for(var y=y0+1;y<y1-1;y++){for(var x=x0+1;x<x1-1;x++){
    var v=4*gray(d,W,x,y)-gray(d,W,x-1,y)-gray(d,W,x+1,y)-gray(d,W,x,y-1)-gray(d,W,x,y+1);
    s+=v*v;
  }}
  return s;
}

/* 8. Vollath F4 */
function vollathF4(d,W,x0,y0,x1,y1){
  var s=0;
  for(var y=y0;y<y1;y++){for(var x=x0;x<x1-1;x++){s+=gray(d,W,x,y)*gray(d,W,x+1,y);}}
  var s2=0,n=0;for(var y2=y0;y2<y1;y2++){for(var x2=x0;x2<x1;x2++){s2+=gray(d,W,x2,y2);n++;}}
  return s-(n>0?(s2*s2/n):0);
}

/* 9. Vollath F6 */
function vollathF6(d,W,x0,y0,x1,y1){
  var s=0;
  for(var y=y0;y<y1;y++){for(var x=x0;x<x1-2;x++){s+=gray(d,W,x,y)*gray(d,W,x+2,y);}}
  var s1=0;for(var y2=y0;y2<y1;y2++){for(var x2=x0;x2<x1-1;x2++){s1+=gray(d,W,x2,y2)*gray(d,W,x2+1,y2);}}
  return s-s1;
}

/* 10. Sum Modulus of Difference (SMD) */
function smd(d,W,x0,y0,x1,y1){
  var s=0;
  for(var y=y0;y<y1-1;y++){for(var x=x0;x<x1-1;x++){
    s+=Math.abs(gray(d,W,x,y)-gray(d,W,x+1,y))+Math.abs(gray(d,W,x,y)-gray(d,W,x,y+1));
  }}
  return s;
}

/* 11. Steerable filter (0 and 90 deg 1st derivative) */
function steerable(d,W,x0,y0,x1,y1){
  var s=0,n=0;
  for(var y=y0+1;y<y1-1;y++){for(var x=x0+1;x<x1-1;x++){
    var fx=gray(d,W,x+1,y)-gray(d,W,x-1,y);
    var fy=gray(d,W,x,y+1)-gray(d,W,x,y-1);
    s+=fx*fx+fy*fy;n++;
  }}
  return n?s/n:0;
}

/* 12. Structure Tensor (sum of eigenvalues) */
function structTens(d,W,x0,y0,x1,y1){
  var Jxx=0,Jxy=0,Jyy=0,n=0;
  for(var y=y0+1;y<y1-1;y++){for(var x=x0+1;x<x1-1;x++){
    var ix=(gray(d,W,x+1,y)-gray(d,W,x-1,y))/2;
    var iy=(gray(d,W,x,y+1)-gray(d,W,x,y-1))/2;
    Jxx+=ix*ix;Jxy+=ix*iy;Jyy+=iy*iy;n++;
  }}
  if(!n)return 0;
  Jxx/=n;Jxy/=n;Jyy/=n;
  /* Sum of eigenvalues = trace = Jxx+Jyy */
  /* Product of eigenvalues = det = Jxx*Jyy - Jxy^2 */
  /* Use trace as sharpness measure */
  return Jxx+Jyy;
}

/* ====== DFD SCAN ====== */
async function runDFD(){
  if(dfdRunning){showToast('Already running','w');return;}
  if(!caps.focusDistance){
    showToast('focusDistance not supported - running edge map','w');
    captureEdgeFrame();return;
  }
  dfdRunning=true;
  var btn=$('btnDFD');btn.textContent='SCANNING...';btn.disabled=true;
  $('dfdStat').textContent='RUNNING';$('scanHud').style.display='block';

  var steps=parseInt($('bSt').value)||12;
  var settle=parseInt($('bStl').value)||220;
  var GW=parseInt($('bGW').value)||20;
  var GH=parseInt($('bGH').value)||15;
  var fdCap=caps.focusDistance;
  var fdMin=fdCap.min,fdMax=fdCap.max;
  var vid=$('video');
  var W=vid.videoWidth||1280,H=vid.videoHeight||720;
  var wc=$('wkCanvas');wc.width=W;wc.height=H;var wctx=wc.getContext('2d');

  try{await applyC({focusMode:'manual'});}catch(e){}

  var stacks=[];/* [{fd,map}] */
  var frames=[];
  var cW=Math.floor(W/GW),cH=Math.floor(H/GH);

  for(var i=0;i<steps;i++){
    var fd=fdMin+(fdMax-fdMin)*(i/(steps-1));
    try{await applyC({focusDistance:fd});}catch(e){}
    await sleep(settle);
    wctx.drawImage(vid,0,0,W,H);
    var img=wctx.getImageData(0,0,W,H);
    var map=new Float32Array(GW*GH);
    for(var gy=0;gy<GH;gy++){for(var gx=0;gx<GW;gx++){
      map[gy*GW+gx]=computeSharp(img.data,W,gx*cW,gy*cH,Math.min((gx+1)*cW,W),Math.min((gy+1)*cH,H),curAlgo);
    }}
    stacks.push({fd:fd,map:map});
    frames.push({fd:fd,snap:img.data.slice(0),W:W,H:H});
    var pct=(i+1)/steps*100;
    $('dfdProg').style.width=pct+'%';$('scanPfill').style.width=pct+'%';
    $('scanTxt').textContent='STEP '+(i+1)+'/'+steps+' fd='+fd.toFixed(3);
    $('dfdStat').textContent=(i+1)+'/'+steps;
    drawBracketStrip(frames,$('bracketCanvas'),steps);
    await sleep(8);
  }

  /* Build depth map */
  var depthMap=new Float32Array(GW*GH);
  var confMap=new Float32Array(GW*GH);
  for(var c=0;c<GW*GH;c++){
    var best=-1,bestFd=fdMin;
    stacks.forEach(function(fr){if(fr.map[c]>best){best=fr.map[c];bestFd=fr.fd;}});
    depthMap[c]=fdToMeters(bestFd,fdCap);
    confMap[c]=best;
  }

  /* Sharpness curves for each algo (compute center column) */
  var curves=stacks.map(function(fr){return fr.map[Math.floor(GH/2)*GW+Math.floor(GW/2)];});
  var fds=stacks.map(function(fr){return fr.fd;});
  drawSharpCurve(curves,fds,$('curveCanvas'));

  lastDFD={map:depthMap,conf:confMap,GW:GW,GH:GH,W:W,H:H,fdMin:fdMin,fdMax:fdMax,frames:frames};
  renderDepthMap(depthMap,GW,GH,$('dfdMapCanvas'));

  var valid=[].filter.call(depthMap,function(v){return v>0;});
  if(valid.length){
    var sorted=valid.slice().sort(function(a,b){return a-b;});
    $('bsS').textContent=steps;
    $('bsN').textContent=fmtDist(sorted[0]);
    $('bsF').textContent=fmtDist(sorted[sorted.length-1]);
    $('ldBig').textContent=fmtDist(sorted[Math.floor(sorted.length/2)]);
  }

  /* Restore focus */
  try{
    if(caps.focusMode){
      var pref=['continuous','auto'];
      for(var pi=0;pi<pref.length;pi++){if(caps.focusMode.indexOf(pref[pi])>=0){await applyC({focusMode:pref[pi]});break;}}
    }
  }catch(e){}

  btn.textContent='RUN SCAN';btn.disabled=false;
  $('dfdStat').textContent='DONE';$('scanHud').style.display='none';
  dfdRunning=false;
  $('pcStat').textContent='Ready - '+valid.length+' cells';
  showToast('Depth scan complete!','ok');
}

function fdToMeters(fd,fc){
  if(!fc)return Math.max(0,fd);
  if(fc.max<=1.0)return 0.05+fd*14;
  if(fc.max>80)return fd>0.005?1/fd:50;
  return fd>0?fd:0;
}

function drawBracketStrip(frames,canvas,total){
  canvas.width=300;canvas.height=90;var cw=300;
  var ch=canvas.height||90;var ctx=canvas.getContext('2d');
  ctx.fillStyle='#000';ctx.fillRect(0,0,cw,ch);
  var sw=Math.floor(cw/total)||1;
  var wc=$('wkCanvas');
  frames.forEach(function(fr,i){
    wc.width=fr.W;wc.height=fr.H;
    var tmp=new ImageData(fr.snap.slice(),fr.W,fr.H);
    wc.getContext('2d').putImageData(tmp,0,0);
    ctx.drawImage(wc,Math.floor(fr.W/2),0,Math.ceil(fr.W/total),fr.H,i*sw,0,sw,ch);
    ctx.fillStyle='rgba(0,255,200,.5)';ctx.font='6px monospace';
    ctx.fillText(fr.fd.toFixed(2),i*sw+1,ch-2);
  });
}

function drawSharpCurve(vals,fds,canvas){
  canvas.width=300;canvas.height=80;var cw=300,ch=80;
  var ctx=canvas.getContext('2d');
  ctx.fillStyle='#060809';ctx.fillRect(0,0,cw,ch);
  if(!vals.length)return;
  var mx=Math.max.apply(null,vals)||1;
  ctx.strokeStyle='var(--a1)';ctx.lineWidth=1.5;ctx.beginPath();
  vals.forEach(function(v,i){
    var x=Math.round(i/(vals.length-1)*(cw-4))+2;
    var y=Math.round((1-v/mx)*(ch-10))+5;
    i===0?ctx.moveTo(x,y):ctx.lineTo(x,y);
  });
  ctx.stroke();
  /* Peak marker */
  var pi=vals.indexOf(Math.max.apply(null,vals));
  var px=Math.round(pi/(vals.length-1)*(cw-4))+2;
  var py=Math.round((1-vals[pi]/mx)*(ch-10))+5;
  ctx.fillStyle='var(--a2)';ctx.beginPath();ctx.arc(px,py,3,0,Math.PI*2);ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.4)';ctx.font='7px monospace';
  ctx.fillText('PEAK fd='+fds[pi].toFixed(3),Math.min(px+4,cw-60),py+4);
  ctx.fillStyle='rgba(255,255,255,.25)';ctx.font='6px monospace';
  ctx.fillText('SHARPNESS CURVE ('+ALGOS.find(function(a){return a.id===curAlgo;}).name+')',2,9);
}

function renderDepthMap(depthMap,GW,GH,canvas){
  canvas.width=300;canvas.height=160;var cw=300,ch=160; ch=canvas.height||160;
  var ctx=canvas.getContext('2d');
  var valid=[].filter.call(depthMap,function(v){return v>0;});
  if(!valid.length){ctx.fillStyle='#0d1318';ctx.fillRect(0,0,cw,ch);return;}
  var dmin=Math.min.apply(null,valid),dmax=Math.max.apply(null,valid),rng=dmax-dmin||1;
  var cW=cw/GW,cH=ch/GH;
  [].forEach.call(depthMap,function(d,i){
    var gy=Math.floor(i/GW),gx=i%GW;
    var t=Math.max(0,Math.min(1,(d-dmin)/rng));
    var r,g,b;
    /* Jet colormap */
    if(t<.25){r=0;g=Math.round(255*t*4);b=255;}
    else if(t<.5){r=0;g=255;b=Math.round(255*(1-(t-.25)*4));}
    else if(t<.75){r=Math.round(255*(t-.5)*4);g=255;b=0;}
    else{r=255;g=Math.round(255*(1-(t-.75)*4));b=0;}
    ctx.fillStyle='rgb('+r+','+g+','+b+')';
    ctx.fillRect(Math.floor(gx*cW),Math.floor(gy*cH),Math.ceil(cW)+1,Math.ceil(cH)+1);
  });
  ctx.font='bold 8px monospace';ctx.textAlign='center';
  [].forEach.call(depthMap,function(d,i){
    if(d<=0)return;
    var gy=Math.floor(i/GW),gx=i%GW;
    var cx=Math.floor(gx*cW+cW/2),cy=Math.floor(gy*cH+cH/2)+3;
    if(cW>20){ctx.fillStyle='rgba(0,0,0,.5)';ctx.fillRect(cx-14,cy-8,28,10);ctx.fillStyle='#fff';ctx.fillText(fmtDist(d),cx,cy);}
  });
  ctx.textAlign='left';
}

function clearDFD(){
  [$('bracketCanvas'),$('dfdMapCanvas'),$('pcCanvas'),$('curveCanvas')].forEach(function(c){if(c){var ctx=c.getContext('2d');ctx.clearRect(0,0,c.width,c.height);}});
  $('dfdProg').style.width='0';$('dfdStat').textContent='IDLE';
  $('bsS').textContent='--';$('bsN').textContent='--';$('bsF').textContent='--';
  lastDFD=null;$('pcStat').textContent='Run scan first';
}
function saveDepthPNG(){
  if(!lastDFD){showToast('Run scan first','w');return;}
  var c=$('dfdMapCanvas'),url=c.toDataURL('image/png');
  var a=document.createElement('a');a.href=url;a.download='depthmap-'+Date.now()+'.png';document.body.appendChild(a);a.click();document.body.removeChild(a);
  showToast('Depth map PNG saved','ok');
}
function saveDepthCSV(){
  if(!lastDFD){showToast('Run scan first','w');return;}
  var r=lastDFD;var rows=['x,y,depth_m'];
  for(var i=0;i<r.map.length;i++){
    var gy=Math.floor(i/r.GW),gx=i%r.GW;
    rows.push(gx+','+gy+','+r.map[i].toFixed(4));
  }
  var blob=new Blob([rows.join('\n')],{type:'text/csv'});
  var url=URL.createObjectURL(blob);
  var a=document.createElement('a');a.href=url;a.download='depthdata-'+Date.now()+'.csv';document.body.appendChild(a);a.click();document.body.removeChild(a);
  URL.revokeObjectURL(url);showToast('CSV saved','ok');
}

/* ====== LIVE EDGE MAP ====== */
function toggleEdgeLive(){edgeLiveOn?stopEdgeLive():startEdgeLive();}
function startEdgeLive(){
  if(edgeLiveOn)return;edgeLiveOn=true;
  $('btnEdgeLive').textContent='STOP';$('btnEdgeLive').style.color='var(--a2)';$('btnEdgeLive').style.borderColor='var(--a2)';
  $('edgeOverlay').style.display='block';
  edgeLoop();
}
function stopEdgeLive(){
  edgeLiveOn=false;if(edgeRAF){cancelAnimationFrame(edgeRAF);edgeRAF=null;}
  $('btnEdgeLive').textContent='START';$('btnEdgeLive').style.color='';$('btnEdgeLive').style.borderColor='';
  $('edgeOverlay').style.display='none';
}
function edgeLoop(){
  if(!edgeLiveOn)return;
  var vid=$('video');
  if(vid.readyState>=2&&vid.videoWidth>0){
    var W=vid.videoWidth,H=vid.videoHeight;
    var wc=$('wkCanvas');wc.width=W;wc.height=H;
    wc.getContext('2d').drawImage(vid,0,0,W,H);
    var img=wc.getContext('2d').getImageData(0,0,W,H);
    /* Render to overlay (always visible in vWrap) */
    renderEdge(img.data,W,H,$('edgeOverlay'));
    /* Also render to edgeMapCanvas in depth tab - use fixed width */
    renderEdgeToCanvas(img.data,W,H,$('edgeMapCanvas'));
  }
  edgeRAF=requestAnimationFrame(edgeLoop);
}
function captureEdgeFrame(){
  var vid=$('video'),W=vid.videoWidth,H=vid.videoHeight;
  if(!W||!H){showToast('Video not ready','w');return;}
  var wc=$('wkCanvas');wc.width=W;wc.height=H;wc.getContext('2d').drawImage(vid,0,0,W,H);
  var img=wc.getContext('2d').getImageData(0,0,W,H);
  $('edgeOverlay').style.display='block';
  renderEdge(img.data,W,H,$('edgeOverlay'));
  renderEdgeToCanvas(img.data,W,H,$('edgeMapCanvas'));
  showTab('depth');showToast('Edge map captured','ok');
}

/* Compute edge grid, render to any canvas - uses hardcoded width fallback */
function computeEdgeGrid(data,W,H,GW,GH){
  var cW=Math.floor(W/GW),cH=Math.floor(H/GH);
  var edges=new Float32Array(GW*GH);
  var maxE=0,sumE=0;
  for(var gy=0;gy<GH;gy++){for(var gx=0;gx<GW;gx++){
    var cx=gx*cW+Math.floor(cW/2),cy=gy*cH+Math.floor(cH/2);
    cx=Math.max(1,Math.min(W-2,cx));cy=Math.max(1,Math.min(H-2,cy));
    var ix=(gray(data,W,cx+1,cy-1)+2*gray(data,W,cx+1,cy)+gray(data,W,cx+1,cy+1)-gray(data,W,cx-1,cy-1)-2*gray(data,W,cx-1,cy)-gray(data,W,cx-1,cy+1));
    var iy=(gray(data,W,cx-1,cy+1)+2*gray(data,W,cx,cy+1)+gray(data,W,cx+1,cy+1)-gray(data,W,cx-1,cy-1)-2*gray(data,W,cx,cy-1)-gray(data,W,cx+1,cy-1));
    var mag=Math.sqrt(ix*ix+iy*iy);
    edges[gy*GW+gx]=mag;if(mag>maxE)maxE=mag;sumE+=mag;
  }}
  return{edges:edges,maxE:maxE,avgE:sumE/(GW*GH)};
}

function edgeColor(t){
  /* t=0 far/blurry=blue, t=1 near/sharp=red */
  var r,g,b;
  if(t>0.7){r=255;g=Math.round(60*(1-t));b=0;}
  else if(t>0.4){r=255;g=Math.round(200*(t-.4)*3.3);b=0;}
  else if(t>0.2){r=0;g=200;b=Math.round(255*(0.4-t)*5);}
  else{r=0;g=Math.round(80*t*5);b=220;}
  return[r,g,b];
}

function renderEdge(data,W,H,canvas){
  /* Always sync overlay canvas to live vWrap size */
  var GW=32,GH=24;
  var res=computeEdgeGrid(data,W,H,GW,GH);
  var edges=res.edges,maxE=res.maxE;
  if(maxE<1)return;
  var vw=$('vWrap');
  var liveW=vw.offsetWidth||300;
  var liveH=vw.offsetHeight||200;
  if(canvas.width!==liveW||canvas.height!==liveH){canvas.width=liveW;canvas.height=liveH;}
  var cw=canvas.width;var ch=canvas.height;
  var ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,cw,ch);
  var dcW=cw/GW,dcH=ch/GH;
  res.edges.forEach(function(mag,i){
    var gy=Math.floor(i/GW),gx=i%GW;
    var t=mag/maxE;var c=edgeColor(t);
    var a=t>0.5?0.65:t>0.25?0.45:0.3;
    ctx.fillStyle='rgba('+c[0]+','+c[1]+','+c[2]+','+a.toFixed(2)+')';
    ctx.fillRect(Math.floor(gx*dcW),Math.floor(gy*dcH),Math.ceil(dcW)+1,Math.ceil(dcH)+1);
  });
  /* Update stats */
  var ci=Math.floor(GH/2)*GW+Math.floor(GW/2);
  $('emMax').textContent=res.maxE.toFixed(1);
  $('emAvg').textContent=res.avgE.toFixed(1);
  $('emCtr').textContent=(res.edges[ci]/res.maxE*100).toFixed(0)+'%';
}

function renderEdgeToCanvas(data,W,H,canvas){
  /* Always use fixed dimensions - never rely on clientWidth (tab may be hidden) */
  var GW=32,GH=24;
  var res=computeEdgeGrid(data,W,H,GW,GH);
  var maxE=res.maxE;if(maxE<1)return;
  canvas.width=300;canvas.height=130;
  var cw=300,ch=130;
  var ctx=canvas.getContext('2d');
  ctx.clearRect(0,0,cw,ch);
  var dcW=cw/GW,dcH=ch/GH;
  res.edges.forEach(function(mag,i){
    var gy=Math.floor(i/GW),gx=i%GW;
    var t=mag/maxE;var c=edgeColor(t);
    ctx.fillStyle='rgb('+c[0]+','+c[1]+','+c[2]+')';
    ctx.fillRect(Math.floor(gx*dcW),Math.floor(gy*dcH),Math.ceil(dcW)+1,Math.ceil(dcH)+1);
  });
}

/* ====== 3D POINT CLOUD ====== */
function renderPC(){
  if(!lastDFD){showToast('Run DFD scan first','w');return;}
  var r=lastDFD;var pts=[];
  [].forEach.call(r.map,function(d,i){
    if(d<=0)return;
    var gy=Math.floor(i/r.GW),gx=i%r.GW;
    pts.push({x:(gx/r.GW-.5)*2,y:(gy/r.GH-.5)*2,z:d,d:d});
  });
  if(!pts.length){$('pcStat').textContent='No valid depth cells';return;}
  var dmin=Math.min.apply(null,pts.map(function(p){return p.d;}));
  var dmax=Math.max.apply(null,pts.map(function(p){return p.d;}));
  var canvas=$('pcCanvas');
  canvas.width=300;var cw=300;
  drawPC(pts,canvas,pcAngle,dmin,dmax);
  $('pcStat').textContent=pts.length+' pts '+fmtDist(dmin)+'-'+fmtDist(dmax);
}

function drawPC(pts,canvas,angle,dmin,dmax){
  var cw=canvas.width,ch=canvas.height;
  var ctx=canvas.getContext('2d');
  ctx.fillStyle='#05080a';ctx.fillRect(0,0,cw,ch);
  var cosA=Math.cos(angle),sinA=Math.sin(angle);
  var scale=Math.min(cw,ch)*.36;var cx=cw/2,cy=ch/2;
  var proj=pts.map(function(p){
    var rx=p.x*cosA-p.z*0.12*sinA;
    var rz=p.x*sinA+p.z*0.12*cosA;
    var per=1/(1+rz*.35);
    var t=(p.d-dmin)/(dmax-dmin||1);
    var r,g,b;
    if(t<.25){r=0;g=Math.round(255*t*4);b=255;}
    else if(t<.5){r=0;g=255;b=Math.round(255*(1-(t-.25)*4));}
    else if(t<.75){r=Math.round(255*(t-.5)*4);g=255;b=0;}
    else{r=255;g=Math.round(255*(1-(t-.75)*4));b=0;}
    return{sx:cx+rx*scale*per,sy:cy+p.y*scale*per*.6,sz:rz,r:r,g:g,b:b,sz2:per};
  });
  proj.sort(function(a,b){return b.sz-a.sz;});
  proj.forEach(function(p){
    var size=Math.max(2,Math.round(p.sz2*6));
    ctx.fillStyle='rgb('+p.r+','+p.g+','+p.b+')';
    ctx.beginPath();ctx.arc(p.sx,p.sy,size,0,Math.PI*2);ctx.fill();
  });
  /* Grid lines */
  ctx.strokeStyle='rgba(255,255,255,.08)';ctx.lineWidth=.5;
  for(var xi=-1;xi<=1;xi+=.5){
    var rx1=xi*cosA;var rz1=xi*sinA;var per1=1/(1+rz1*.35);
    var rx2=-0.5*0.12*sinA;var rz2=-0.5*0.12*cosA;var per2=1/(1+rz2*.35);
    ctx.beginPath();ctx.moveTo(cx+rx1*scale*per1,cy+(-1)*scale*per1*.6);ctx.lineTo(cx+rx1*scale*per1,cy+(1)*scale*per1*.6);ctx.stroke();
  }
}

function togglePCRot(){
  pcRotating=!pcRotating;
  $('btnPCRot').style.color=pcRotating?'var(--a1)':'var(--muted)';
  $('btnPCRot').style.borderColor=pcRotating?'var(--a1)':'var(--border2)';
  if(pcRotating)pcRotLoop();
  else if(pcRotRAF){cancelAnimationFrame(pcRotRAF);pcRotRAF=null;}
}
function pcRotLoop(){
  if(!pcRotating||!lastDFD)return;
  pcAngle+=0.018;
  var r=lastDFD;var pts=[];
  [].forEach.call(r.map,function(d,i){
    if(d<=0)return;
    var gy=Math.floor(i/r.GW),gx=i%r.GW;
    pts.push({x:(gx/r.GW-.5)*2,y:(gy/r.GH-.5)*2,z:d,d:d});
  });
  if(!pts.length)return;
  var dmin=Math.min.apply(null,pts.map(function(p){return p.d;}));
  var dmax=Math.max.apply(null,pts.map(function(p){return p.d;}));
  drawPC(pts,$('pcCanvas'),pcAngle,dmin,dmax);
  pcRotRAF=requestAnimationFrame(pcRotLoop);
}
function savePC(){
  var c=$('pcCanvas');if(!c.width){showToast('Render first','w');return;}
  var url=c.toDataURL('image/png');var a=document.createElement('a');a.href=url;a.download='pointcloud-'+Date.now()+'.png';document.body.appendChild(a);a.click();document.body.removeChild(a);showToast('Point cloud saved','ok');
}

/* ====== STEREO ====== */
async function runStereo(){
  var idL=$('camL').value,idR=$('camR').value;
  if(!idL||!idR){showToast('Select cameras','w');return;}
  if(idL===idR){showToast('Select different cameras','w');return;}
  $('stereoStat').textContent='Capturing cam A...';
  try{
    async function capFromCam(did){
      var s=await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:did},width:{ideal:1280},height:{ideal:720}},audio:false});
      var v=document.createElement('video');v.srcObject=s;v.muted=true;v.playsInline=true;v.setAttribute('playsinline','');
      await new Promise(function(r){v.onloadedmetadata=r;setTimeout(r,3000);});
      await v.play().catch(function(){});
      await sleep(700);/* let AGC settle */
      var wc=$('wkCanvas');wc.width=v.videoWidth;wc.height=v.videoHeight;
      wc.getContext('2d').drawImage(v,0,0);
      var img=wc.getContext('2d').getImageData(0,0,v.videoWidth,v.videoHeight);
      s.getTracks().forEach(function(t){t.stop();});
      return img;
    }
    var imgA=await capFromCam(idL);
    $('stereoStat').textContent='Capturing cam B...';
    var imgB=await capFromCam(idR);
    $('stereoStat').textContent='Computing disparity...';
    $('stereoRes').textContent=imgA.width+'x'+imgA.height;

    /* Render side-by-side preview */
    var prev=$('stereoPreview');
    prev.width=300;prev.height=100;var pw=300;
    var pctx=prev.getContext('2d');
    var half=Math.floor(pw/2);
    var tmpA=document.createElement('canvas');tmpA.width=imgA.width;tmpA.height=imgA.height;tmpA.getContext('2d').putImageData(imgA,0,0);
    var tmpB=document.createElement('canvas');tmpB.width=imgB.width;tmpB.height=imgB.height;tmpB.getContext('2d').putImageData(imgB,0,0);
    pctx.drawImage(tmpA,0,0,half,100);pctx.drawImage(tmpB,half,0,half,100);
    pctx.strokeStyle='rgba(0,255,200,.3)';pctx.lineWidth=1;pctx.beginPath();pctx.moveTo(half,0);pctx.lineTo(half,100);pctx.stroke();

    await sleep(20);

    /* Compute disparity */
    var blockSz=parseInt($('sadB').value)||8;
    var maxDisp=parseInt($('maxD').value)||64;
    var W=Math.min(imgA.width,imgB.width),H=Math.min(imgA.height,imgB.height);
    var disp=computeSAD(imgA.data,imgB.data,W,H,blockSz,maxDisp);
    lastStereo={disp:disp,W:W,H:H,maxDisp:maxDisp};

    renderDispMap(disp,W,H,maxDisp,$('stereoDisp'));
    /* Compute approximate depth from disparity (assume ~6cm baseline, ~28mm equiv FL) */
    renderStereoDepth(disp,W,H,maxDisp,$('stereoDepth'));

    /* Restore main preview stream */
    if(stream&&$('video').srcObject!==stream){
      $('video').srcObject=stream;
      $('video').play().catch(function(){});
    }
    $('stereoStat').textContent='Done';showToast('Stereo complete','ok');
  }catch(e){
    $('stereoStat').textContent='Error: '+e.name;
    showToast('Stereo failed: '+e.message,'err');
  }
}

function computeSAD(dL,dR,W,H,B,maxD){
  var disp=new Uint8Array(W*H);
  var step=2;/* subsample for speed */
  for(var y=B;y<H-B;y+=step){
    for(var x=B;x<W-B;x+=step){
      var bestSAD=1e9,bestD=0;
      for(var d=0;d<maxD;d++){
        if(x-d-B<0)break;
        var sad=0;
        for(var by=-B;by<=B;by+=step){for(var bx=-B;bx<=B;bx+=step){
          var il=((y+by)*W+(x+bx))*4,ir=((y+by)*W+(x+bx-d))*4;
          sad+=Math.abs(.299*(dL[il]-dR[ir])+.587*(dL[il+1]-dR[ir+1])+.114*(dL[il+2]-dR[ir+2]));
        }}
        if(sad<bestSAD){bestSAD=sad;bestD=d;}
      }
      for(var fy=0;fy<step;fy++){for(var fx=0;fx<step;fx++){
        if(y+fy<H&&x+fx<W)disp[(y+fy)*W+(x+fx)]=bestD;
      }}
    }
  }
  return disp;
}

function dispColor(t){
  /* t=1 near=red, t=0 far=blue */
  var r,g,b;
  if(t>.66){r=255;g=Math.round(255*(1-t)*3);b=0;}
  else if(t>.33){r=Math.round(255*(t-.33)*3);g=255;b=0;}
  else{r=0;g=Math.round(255*t*3);b=255;}
  return[r,g,b];
}

function renderDispMap(disp,W,H,maxD,canvas){
  canvas.width=300;canvas.height=140;var cw=300,ch=140;
  var ctx=canvas.getContext('2d');var img2=ctx.createImageData(cw,ch);
  for(var y=0;y<ch;y++){for(var x=0;x<cw;x++){
    var sx=Math.floor(x/cw*W),sy=Math.floor(y/ch*H);
    var d=disp[sy*W+sx]/maxD;var c=dispColor(d);
    var ii=(y*cw+x)*4;img2.data[ii]=c[0];img2.data[ii+1]=c[1];img2.data[ii+2]=c[2];img2.data[ii+3]=255;
  }}
  ctx.putImageData(img2,0,0);
  ctx.font='8px monospace';ctx.fillStyle='rgba(255,255,255,.5)';ctx.fillText('DISPARITY MAP',2,10);
}

function renderStereoDepth(disp,W,H,maxD,canvas){
  var f=28,B=0.06,pixSz=0.001;
  canvas.width=300;canvas.height=140;var cw=300,ch=140;
  var ctx=canvas.getContext('2d');var img2=ctx.createImageData(cw,ch);
  var depths=[];
  for(var i=0;i<disp.length;i++){if(disp[i]>1)depths.push(f*B/(disp[i]*pixSz));}
  if(!depths.length){ctx.fillStyle='#0d1318';ctx.fillRect(0,0,cw,ch);return;}
  var dmin=Math.min.apply(null,depths.filter(function(v){return v<50;}));
  var dmax=Math.min(20,Math.max.apply(null,depths.filter(function(v){return v<50;})));
  var rng=dmax-dmin||1;
  for(var y=0;y<ch;y++){for(var x=0;x<cw;x++){
    var sx=Math.floor(x/cw*W),sy=Math.floor(y/ch*H);
    var dv=disp[sy*W+sx];
    var depth=dv>1?f*B/(dv*pixSz):dmax+1;
    var t=1-Math.max(0,Math.min(1,(depth-dmin)/rng));
    var c=dispColor(t);
    var ii=(y*cw+x)*4;img2.data[ii]=c[0];img2.data[ii+1]=c[1];img2.data[ii+2]=c[2];img2.data[ii+3]=255;
  }}
  ctx.putImageData(img2,0,0);
  ctx.font='8px monospace';ctx.fillStyle='rgba(255,255,255,.5)';
  ctx.fillText('STEREO DEPTH (approx, needs calibration)',2,10);
}

function saveStereoDisp(){
  if(!lastStereo){showToast('Run stereo first','w');return;}
  var c=$('stereoDisp'),url=c.toDataURL('image/png');
  var a=document.createElement('a');a.href=url;a.download='disparity-'+Date.now()+'.png';document.body.appendChild(a);a.click();document.body.removeChild(a);showToast('Disparity map saved','ok');
}
function clearStereo(){
  [$('stereoPreview'),$('stereoDisp'),$('stereoDepth')].forEach(function(c){if(c&&c.width)c.getContext('2d').clearRect(0,0,c.width,c.height);});
  $('stereoStat').textContent='Idle';$('stereoRes').textContent='--';lastStereo=null;
}

/* TORCH */
async function toggleTorch(){
  if(!caps.torch){showToast('Torch not supported','w');return;}
  torchOn=!torchOn;await applyC({torch:torchOn});updateTorchBtn();var t=$('tTog');if(t)t.checked=torchOn;
}
function updateTorchBtn(){var b=$('torchBtn');torchOn?b.classList.add('on'):b.classList.remove('on');}

/* RESET */
async function resetAll(){
  if(!track)return;var o={};
  if(caps.brightness)o.brightness=Math.round((caps.brightness.min+caps.brightness.max)/2);
  if(caps.contrast)o.contrast=Math.round((caps.contrast.min+caps.contrast.max)/2);
  if(caps.saturation)o.saturation=Math.round((caps.saturation.min+caps.saturation.max)/2);
  if(caps.sharpness)o.sharpness=Math.round((caps.sharpness.min+caps.sharpness.max)/2);
  if(caps.exposureCompensation)o.exposureCompensation=0;
  if(caps.zoom)o.zoom=caps.zoom.min;
  if(caps.torch)o.torch=false;
  if(Object.keys(o).length)await applyC(o);
  torchOn=false;updateTorchBtn();buildAll();showToast('Reset','ok');
}
function refresh(){readCaps();buildAll();showToast('Refreshed','ok');}

/* UI */
function togS(h){h.classList.toggle('closed');h.nextElementSibling.classList.toggle('hidden');}
function showTab(n){
  document.querySelectorAll('.tp').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
  $('panel-'+n).classList.add('active');$('tab-'+n).classList.add('active');
  $('panelWrap').scrollTop=0;
}
var _tt=null;
function showToast(msg,t){var el=$('toast');el.textContent=msg;el.className='toast show'+(t?' '+t:'');clearTimeout(_tt);_tt=setTimeout(function(){el.className='toast';},2800);}
function showInitErr(title,msg,hint){$('errTitle').textContent=title;$('errMsg').textContent=msg;$('errBox').style.display='block';if(hint){$('hintBox').textContent=hint;$('hintBox').style.display='block';}}
function hideErr(){$('errBox').style.display='none';$('hintBox').style.display='none';}

</script>
</body>
</html>
