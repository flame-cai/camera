<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
<meta name="mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<title>PRISM - Camera Control</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Mono:wght@300;400;500&family=Syne:wght@700;800&display=swap" rel="stylesheet">
<style>

*,*::before,*::after{margin:0;padding:0;box-sizing:border-box;-webkit-tap-highlight-color:transparent}
:root{
  --bg:#08090b;--bg2:#0d1014;--card:#101418;--card2:#14191e;
  --border:#1c252c;--border2:#243038;
  --a1:#00ffc8;--a2:#ff4757;--a3:#ffd32a;
  --text:#dde8ec;--muted:#4a606a;--muted2:#2a3840;
  --safe-top:env(safe-area-inset-top,0px);--safe-bot:env(safe-area-inset-bottom,0px);
}
html,body{height:100%;background:var(--bg);color:var(--text);font-family:'DM Mono',monospace;overflow:hidden}
#initScreen{position:fixed;inset:0;z-index:200;display:flex;flex-direction:column;align-items:center;justify-content:center;gap:22px;background:var(--bg);padding:40px 28px;overflow-y:auto}
.logo{font-family:'Syne',sans-serif;font-size:3rem;font-weight:800;color:var(--a1);letter-spacing:14px;text-align:center}
.logo-sub{font-size:0.5rem;letter-spacing:5px;text-transform:uppercase;color:var(--muted);text-align:center;margin-top:-14px}
.init-btn{font-family:'DM Mono',monospace;font-size:0.72rem;letter-spacing:4px;text-transform:uppercase;padding:16px 44px;border:1.5px solid var(--a1);background:transparent;color:var(--a1);border-radius:2px;cursor:pointer;-webkit-appearance:none;transition:all .15s}
.init-btn:active{background:var(--a1);color:#000;transform:scale(.97)}
.sec-btn{font-family:'DM Mono',monospace;font-size:0.6rem;letter-spacing:2px;text-transform:uppercase;padding:11px 26px;border:1px solid var(--border2);background:transparent;color:var(--muted);border-radius:2px;cursor:pointer;-webkit-appearance:none;display:none}
.err-box{width:100%;max-width:360px;border:1px solid var(--a2);background:rgba(255,71,87,.06);padding:14px 16px;border-radius:2px;font-size:0.58rem;line-height:1.9;color:#ff8a96;display:none;white-space:pre-line}
.err-title{font-size:0.62rem;color:var(--a2);font-weight:500;letter-spacing:2px;text-transform:uppercase;margin-bottom:8px}
.hint-box{width:100%;max-width:360px;border:1px solid var(--border);background:var(--card);padding:13px 16px;border-radius:2px;font-size:0.55rem;line-height:2;color:var(--muted);display:none;white-space:pre-line}
.spinner{width:22px;height:22px;border:2px solid var(--border2);border-top-color:var(--a1);border-radius:50%;animation:spin .8s linear infinite;display:none}
@keyframes spin{to{transform:rotate(360deg)}}
#app{position:fixed;inset:0;display:none;flex-direction:column}
#videoWrap{position:relative;background:#000;width:100%;overflow:hidden;flex:0 0 auto}
video{width:100%;display:block;object-fit:cover}
.flash{position:absolute;inset:0;background:#fff;pointer-events:none;opacity:0}
@keyframes flashOut{0%{opacity:.9}100%{opacity:0}}
.crosshair{position:absolute;inset:0;pointer-events:none;display:flex;align-items:center;justify-content:center}
.crosshair::before{content:'';width:36px;height:1px;background:rgba(0,255,200,.3);position:absolute}
.crosshair::after{content:'';width:1px;height:36px;background:rgba(0,255,200,.3);position:absolute}
.vid-top{position:absolute;top:0;left:0;right:0;padding:calc(var(--safe-top) + 8px) 12px 8px;display:flex;justify-content:space-between;align-items:flex-start;pointer-events:none}
.badge{font-size:0.5rem;letter-spacing:1.5px;text-transform:uppercase;background:rgba(0,0,0,.6);border:1px solid rgba(255,255,255,.12);padding:5px 9px;border-radius:2px;line-height:1.9;backdrop-filter:blur(6px);-webkit-backdrop-filter:blur(6px)}
.live-dot{display:inline-block;width:5px;height:5px;border-radius:50%;background:var(--a2);margin-right:5px;vertical-align:middle;animation:blink 1.1s infinite}
@keyframes blink{0%,100%{opacity:1}50%{opacity:.15}}
.vid-bot{position:absolute;bottom:0;left:0;right:0;padding:8px 16px;display:flex;justify-content:space-between;align-items:center;background:linear-gradient(transparent,rgba(0,0,0,.75))}
.icon-btn{width:44px;height:44px;border-radius:50%;border:1.5px solid rgba(255,255,255,.2);background:rgba(0,0,0,.5);color:#fff;font-size:1.05rem;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none;backdrop-filter:blur(4px);-webkit-backdrop-filter:blur(4px)}
.icon-btn:active{transform:scale(.88);border-color:var(--a1)}
.icon-btn.on{border-color:var(--a1);background:rgba(0,255,200,.15);color:var(--a1)}
.shutter{width:58px;height:58px;border-radius:50%;border:3px solid var(--a1);background:transparent;display:flex;align-items:center;justify-content:center;cursor:pointer;-webkit-appearance:none}
.shutter-inner{width:42px;height:42px;border-radius:50%;background:rgba(0,255,200,.12);transition:all .1s}
.shutter:active .shutter-inner{background:var(--a1);transform:scale(.84)}
.dev-bar{display:flex;overflow-x:auto;background:var(--card2);border-top:1px solid var(--border);flex-shrink:0;-webkit-overflow-scrolling:touch}
.dev-bar::-webkit-scrollbar{display:none}
.dev-btn{flex-shrink:0;font-family:'DM Mono',monospace;font-size:0.5rem;letter-spacing:1.5px;text-transform:uppercase;padding:9px 14px;border:none;border-right:1px solid var(--border);border-bottom:2px solid transparent;background:transparent;color:var(--muted);cursor:pointer;white-space:nowrap}
.dev-btn.active{color:var(--a1);border-bottom-color:var(--a1)}
.warn{background:rgba(255,71,87,.08);border-bottom:1px solid rgba(255,71,87,.4);padding:7px 14px;font-size:0.52rem;color:#ff8a96;letter-spacing:.5px;display:none;flex-shrink:0}
.tabs{display:flex;background:var(--card);border-top:1px solid var(--border);border-bottom:1px solid var(--border);flex-shrink:0}
.tab{flex:1;padding:10px 2px;font-size:0.47rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--muted);text-align:center;cursor:pointer;border-bottom:2px solid transparent;-webkit-appearance:none;background:none;border-top:none;border-left:none;border-right:none;font-family:'DM Mono',monospace;line-height:1.3}
.tab .ti{font-size:.9rem;display:block;margin-bottom:2px}
.tab.active{color:var(--a1);border-bottom-color:var(--a1)}
#panelWrap{flex:1;overflow-y:auto;overflow-x:hidden;-webkit-overflow-scrolling:touch;overscroll-behavior:contain;background:var(--bg)}
#panelWrap::-webkit-scrollbar{display:none}
.tab-panel{display:none;padding:10px 12px 90px}
.tab-panel.active{display:block}
.section{margin-bottom:8px;border:1px solid var(--border);border-radius:3px;overflow:hidden;background:var(--card)}
.sec-head{display:flex;align-items:center;justify-content:space-between;padding:11px 13px;background:var(--card2);cursor:pointer;user-select:none;-webkit-user-select:none}
.sec-left{display:flex;align-items:center;gap:8px}
.sec-title{font-size:0.55rem;letter-spacing:2.5px;text-transform:uppercase;color:var(--text)}
.sec-tag{font-size:0.42rem;letter-spacing:1.5px;text-transform:uppercase;border:1px solid var(--a1);color:var(--a1);padding:2px 5px;border-radius:1px}
.sec-chev{font-size:0.55rem;color:var(--muted);transition:transform .2s}
.sec-head.closed .sec-chev{transform:rotate(-90deg)}
.sec-body{padding:12px 13px;display:flex;flex-direction:column;gap:15px}
.sec-body.hidden{display:none}
.ctrl{display:flex;flex-direction:column;gap:6px}
.ctrl-head{display:flex;justify-content:space-between;align-items:center}
.ctrl-name{font-size:0.55rem;letter-spacing:1.5px;text-transform:uppercase;color:var(--text)}
.ctrl-val{font-size:0.6rem;color:var(--a1);font-weight:500;letter-spacing:1px;min-width:70px;text-align:right}
.ctrl-range-info{font-size:0.44rem;color:var(--muted);letter-spacing:.5px;display:flex;justify-content:space-between;margin-top:-2px}
.na-badge{font-size:0.44rem;color:var(--muted);border:1px solid var(--border2);padding:2px 6px;letter-spacing:1px;border-radius:1px}
input[type=range]{-webkit-appearance:none;appearance:none;width:100%;height:3px;background:var(--border2);outline:none;cursor:pointer;border-radius:2px;margin:4px 0}
input[type=range]::-webkit-slider-thumb{-webkit-appearance:none;width:26px;height:26px;border-radius:50%;background:var(--a1);cursor:pointer;border:3px solid var(--bg);box-shadow:0 0 0 1px var(--a1);transition:transform .1s}
input[type=range]:active::-webkit-slider-thumb{transform:scale(1.3)}
input[type=range]:disabled{opacity:.2;cursor:not-allowed}
select{width:100%;background:var(--bg2);border:1px solid var(--border2);color:var(--text);font-family:'DM Mono',monospace;font-size:0.62rem;padding:11px 12px;outline:none;cursor:pointer;letter-spacing:1px;border-radius:2px;-webkit-appearance:none;appearance:none}
select:focus{border-color:var(--a1)}
select:disabled{opacity:.25}
.tog-row{display:flex;align-items:center;justify-content:space-between}
.tog-name{font-size:0.55rem;letter-spacing:1.5px;text-transform:uppercase}
.toggle{position:relative;width:48px;height:26px;flex-shrink:0}
.toggle input{opacity:0;width:0;height:0}
.tog-track{position:absolute;inset:0;background:var(--border2);border-radius:13px;cursor:pointer;transition:all .2s;border:1px solid var(--border2)}
.tog-track::before{content:'';position:absolute;width:20px;height:20px;left:2px;top:2px;border-radius:50%;background:var(--muted);transition:all .2s}
input:checked+.tog-track{background:rgba(0,255,200,.12);border-color:var(--a1)}
input:checked+.tog-track::before{transform:translateX(22px);background:var(--a1)}
input:disabled+.tog-track{opacity:.2;cursor:not-allowed}
.info-grid{display:grid;grid-template-columns:1fr 1fr;gap:5px}
.ic{background:var(--card2);border:1px solid var(--border);border-radius:2px;padding:8px 10px}
.ic.full{grid-column:1/-1}
.ik{font-size:0.44rem;color:var(--muted);text-transform:uppercase;letter-spacing:1.5px;margin-bottom:3px}
.iv{font-size:0.62rem;color:var(--a1);word-break:break-all;line-height:1.4}
.cap-tbl{width:100%;border-collapse:collapse;font-size:0.52rem}
.cap-tbl th{text-align:left;color:var(--muted);font-size:0.42rem;letter-spacing:2px;text-transform:uppercase;padding:7px 10px;border-bottom:1px solid var(--border);background:var(--card2);font-weight:400}
.cap-tbl td{padding:8px 10px;border-bottom:1px solid var(--border);vertical-align:top;line-height:1.6}
.cap-tbl tr:last-child td{border-bottom:none}
.cap-tbl td:first-child{color:var(--text);width:40%;font-size:0.5rem}
.cap-tbl .ok{color:var(--a1)}
.cap-tbl .no{color:var(--muted)}
.v-chip{display:inline-block;background:var(--card2);border:1px solid var(--border2);padding:1px 5px;margin:1px;border-radius:1px;font-size:0.46rem;color:var(--a1)}
.toast{position:fixed;bottom:calc(var(--safe-bot) + 76px);left:50%;transform:translateX(-50%);background:var(--card2);border:1px solid var(--border2);color:var(--text);font-size:0.57rem;letter-spacing:1.5px;padding:9px 18px;border-radius:2px;z-index:999;opacity:0;transition:opacity .2s;white-space:nowrap;pointer-events:none}
.toast.show{opacity:1}
.toast.ok{border-color:var(--a1);color:var(--a1)}
.toast.err{border-color:var(--a2);color:var(--a2)}
.act-btn{flex:1;font-family:'DM Mono',monospace;font-size:0.55rem;letter-spacing:2px;text-transform:uppercase;padding:13px;border-radius:2px;cursor:pointer;-webkit-appearance:none}

</style>
</head>
<body>

<div id="initScreen">
  <div>
    <div class="logo">PRISM</div>
    <div class="logo-sub">Full Camera Control</div>
  </div>
  <div class="spinner" id="spinner"></div>
  <button class="init-btn" id="startBtn" onclick="startCam()">INITIALIZE CAMERA</button>
  <button class="sec-btn" id="frontBtn" onclick="startCam(null,'user')">TRY FRONT CAMERA</button>
  <div class="err-box" id="errBox"><div class="err-title" id="errTitle"></div><span id="errMsg"></span></div>
  <div class="hint-box" id="hintBox"></div>
</div>

<div id="app">
  <div id="videoWrap">
    <video id="video" autoplay muted playsinline webkit-playsinline></video>
    <div class="flash" id="flash"></div>
    <div class="crosshair"></div>
    <div class="vid-top">
      <div class="badge" id="liveBadge"><span class="live-dot"></span>LIVE<br><span id="resText" style="color:var(--muted)">loading...</span></div>
      <div class="badge" id="readout" style="text-align:right;font-size:0.47rem;line-height:2;min-width:80px"></div>
    </div>
    <div class="vid-bot">
      <button class="icon-btn" id="torchBtn" onclick="toggleTorch()" title="Torch">&#128294;</button>
      <button class="shutter" onclick="snap()" title="Capture"><div class="shutter-inner"></div></button>
      <button class="icon-btn" onclick="flipCam()" title="Flip">&#128260;</button>
    </div>
  </div>

  <div class="dev-bar" id="devBar"></div>
  <div class="warn" id="warn"></div>

  <div class="tabs">
    <button class="tab active" onclick="showTab('ctrl')" id="tab-ctrl"><span class="ti">&#127917;</span>Controls</button>
    <button class="tab" onclick="showTab('caps')" id="tab-caps"><span class="ti">&#128203;</span>Capabilities</button>
    <button class="tab" onclick="showTab('info')" id="tab-info"><span class="ti">&#8505;&#65039;</span>Info</button>
  </div>

  <div id="panelWrap">
    <div class="tab-panel active" id="panel-ctrl">
      <div id="cExposure"></div>
      <div id="cFocus"></div>
      <div id="cWB"></div>
      <div id="cImage"></div>
      <div id="cStream"></div>
      <div id="cTorch"></div>
      <div style="margin-top:12px;display:flex;gap:8px">
        <button class="act-btn" style="border:1px solid var(--border2);background:transparent;color:var(--text)" onclick="resetAll()">RESET ALL</button>
        <button class="act-btn" style="border:1px solid var(--a1);background:transparent;color:var(--a1)" onclick="refresh()">REFRESH</button>
        <button class="act-btn" style="border:1px solid var(--a2);background:transparent;color:var(--a2)" onclick="stopCam()">STOP</button>
      </div>
    </div>

    <div class="tab-panel" id="panel-caps">
      <div class="section">
        <div class="sec-head" onclick="togSec(this)">
          <div class="sec-left"><span class="sec-title">All Capabilities &amp; Ranges</span></div>
          <span class="sec-chev">&#9662;</span>
        </div>
        <div class="sec-body">
          <table class="cap-tbl">
            <thead><tr><th>Property</th><th>Supported Range / Values</th></tr></thead>
            <tbody id="capBody"></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="tab-panel" id="panel-info">
      <div class="info-grid" id="infoGrid"></div>
      <div style="margin-top:8px" class="section">
        <div class="sec-head" onclick="togSec(this)">
          <div class="sec-left"><span class="sec-title">Live Settings Snapshot</span></div>
          <span class="sec-chev">&#9662;</span>
        </div>
        <div class="sec-body">
          <table class="cap-tbl">
            <thead><tr><th>Setting</th><th>Current Value</th></tr></thead>
            <tbody id="setBody"></tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="toast" id="toast"></div>
<canvas id="canvas" style="display:none"></canvas>

<script>

'use strict';
var stream=null,track=null,ic=null,caps={},sets={},torchOn=false,facing='environment',devs=[];
function $(id){return document.getElementById(id);}

function setVH(){
  var vw=window.innerWidth,vh=window.innerHeight;
  var h=vw>vh?Math.round(vh*0.52):Math.round(vh*0.38);
  $('videoWrap').style.height=h+'px';
}
window.addEventListener('load',function(){
  setVH();
  if(!window.isSecureContext){
    showInitErr('Insecure Context','Camera requires HTTPS or localhost.',
      'Android: open http://localhost in Chrome\niOS: use localhost via Safari\nRemote: use https:// with a valid cert');
    $('startBtn').disabled=true;return;
  }
  if(!navigator.mediaDevices||!navigator.mediaDevices.getUserMedia){
    showInitErr('Camera API Unavailable','getUserMedia not supported in this browser/context.',
      'Use Chrome on Android\nUse Safari 14.3+ on iOS\nMust be on localhost or HTTPS');
    $('startBtn').disabled=true;
  }
});
window.addEventListener('resize',setVH);
window.addEventListener('orientationchange',function(){setTimeout(setVH,300);});

async function startCam(deviceId,f){
  var btn=$('startBtn');
  btn.disabled=true;btn.textContent='REQUESTING...';
  $('spinner').style.display='block';
  hideErr();
  var fc=f||facing;
  try{
    if(stream)stream.getTracks().forEach(function(t){t.stop();});
    var c;
    if(deviceId){
      c={video:{deviceId:{exact:deviceId},width:{ideal:4096},height:{ideal:2160}},audio:false};
    }else{
      c={video:{facingMode:{ideal:fc},width:{ideal:4096},height:{ideal:2160}},audio:false};
    }
    stream=await navigator.mediaDevices.getUserMedia(c);
    var vid=$('video');vid.srcObject=stream;
    await new Promise(function(r){vid.onloadedmetadata=r;setTimeout(r,3000);});
    await vid.play().catch(function(){});
    track=stream.getVideoTracks()[0];
    facing=track.getSettings().facingMode||fc;
    if('ImageCapture' in window){try{ic=new ImageCapture(track);}catch(e){ic=null;}}
    await loadDevs();
    readCaps();
    buildAll();
    startOv();
    $('initScreen').style.display='none';
    $('app').style.display='flex';
    $('app').style.flexDirection='column';
    updateTorch();
  }catch(e){
    handleErr(e);
    btn.disabled=false;
    btn.textContent='TRY AGAIN';
  }
  $('spinner').style.display='none';
}

function handleErr(e){
  var title='Error',msg=e.message||String(e),hint='';
  if(e.name==='NotAllowedError'||e.name==='PermissionDeniedError'){
    title='Permission Denied';
    msg='Camera access was blocked.';
    hint='Android Chrome:\n  Tap the lock icon in address bar\n  Site Settings > Camera > Allow\n  Reload the page\n\niOS Safari:\n  Settings > Safari > Camera > Allow\n  Reload the page';
    $('frontBtn').style.display='block';
  }else if(e.name==='NotFoundError'||e.name==='DevicesNotFoundError'){
    title='No Camera Found';msg='No camera was detected.';
    hint='Check if another app is using the camera.\nRestart browser and try again.';
  }else if(e.name==='NotReadableError'||e.name==='TrackStartError'){
    title='Camera Busy';msg='Camera is in use by another app.';
    hint='Close other apps using the camera.\nRestart the browser.';
  }else if(e.name==='OverconstrainedError'){
    title='Retrying...';msg='High-res failed, trying lower resolution.';
    navigator.mediaDevices.getUserMedia({video:{facingMode:facing},audio:false}).then(function(s){
      stream=s;$('video').srcObject=s;
      return new Promise(function(r){$('video').onloadedmetadata=r;setTimeout(r,2000);});
    }).then(function(){
      track=stream.getVideoTracks()[0];
      readCaps();buildAll();startOv();
      $('initScreen').style.display='none';
      $('app').style.display='flex';$('app').style.flexDirection='column';
    }).catch(function(e2){handleErr(e2);});
    return;
  }else if(e.name==='SecurityError'){
    title='Security Error';msg='Blocked by browser security policy.';
    hint='Access via http://localhost or HTTPS only.';
  }
  showInitErr(title,msg,hint);
}

async function loadDevs(){
  try{
    var all=await navigator.mediaDevices.enumerateDevices();
    devs=all.filter(function(d){return d.kind==='videoinput';});
    var bar=$('devBar');bar.innerHTML='';
    var cur=track&&track.getSettings()?track.getSettings().deviceId:null;
    devs.forEach(function(d,i){
      var b=document.createElement('button');
      b.className='dev-btn'+(d.deviceId===cur?' active':'');
      b.textContent=d.label||('Camera '+(i+1));
      b.onclick=function(){startCam(d.deviceId);};
      bar.appendChild(b);
    });
  }catch(e){}
}

function flipCam(){facing=facing==='environment'?'user':'environment';startCam(null,facing);}

function readCaps(){
  if(!track)return;
  caps=track.getCapabilities?track.getCapabilities():{};
  sets=track.getSettings?track.getSettings():{};
}

async function applyC(obj){
  if(!track)return;
  try{
    await track.applyConstraints({advanced:[obj]});
    sets=track.getSettings();
    updReadout();
  }catch(e){
    showWarn('Cannot apply ['+Object.keys(obj).join(',')+'] - '+e.message);
  }
}

function showWarn(msg){
  var w=$('warn');w.textContent=msg;w.style.display='block';
  clearTimeout(showWarn._t);
  showWarn._t=setTimeout(function(){w.style.display='none';},4000);
}

/* BUILD ALL */
function buildAll(){buildCtrl();buildCapsTab();buildInfoTab();}

function buildCtrl(){
  buildSec('cExposure','Exposure','LIVE',[
    mkSel('exposureMode','Exposure Mode',caps.exposureMode,sets.exposureMode,function(v){applyC({exposureMode:v});},!!caps.exposureMode),
    mkRange('exposureTime','Exposure Time',caps.exposureTime,sets.exposureTime,'us',function(v){applyC({exposureTime:v});},!!caps.exposureTime),
    mkRange('expComp','Exp. Compensation',caps.exposureCompensation||{min:-3,max:3,step:0.1},sets.exposureCompensation!=null?sets.exposureCompensation:0,'EV',function(v){applyC({exposureCompensation:v});},!!caps.exposureCompensation),
    mkRange('iso','ISO Sensitivity',caps.iso,sets.iso,'',function(v){applyC({iso:v});},!!caps.iso),
  ]);
  buildSec('cFocus','Focus','LIVE',[
    mkSel('focusMode','Focus Mode',caps.focusMode,sets.focusMode,function(v){applyC({focusMode:v});},!!caps.focusMode),
    mkRange('focusDist','Focus Distance',caps.focusDistance,sets.focusDistance,'m',function(v){applyC({focusDistance:v});},!!caps.focusDistance),
  ]);
  buildSec('cWB','White Balance','LIVE',[
    mkSel('wbMode','WB Mode',caps.whiteBalanceMode,sets.whiteBalanceMode,function(v){applyC({whiteBalanceMode:v});},!!caps.whiteBalanceMode),
    mkRange('colorTemp','Color Temp',caps.colorTemperature,sets.colorTemperature,'K',function(v){applyC({colorTemperature:v});},!!caps.colorTemperature),
  ]);
  buildSec('cImage','Image Adjustments','LIVE',[
    mkRange('brightness','Brightness',caps.brightness,sets.brightness,'%',function(v){applyC({brightness:v});},!!caps.brightness),
    mkRange('contrast','Contrast',caps.contrast,sets.contrast,'%',function(v){applyC({contrast:v});},!!caps.contrast),
    mkRange('saturation','Saturation',caps.saturation,sets.saturation,'%',function(v){applyC({saturation:v});},!!caps.saturation),
    mkRange('sharpness','Sharpness',caps.sharpness,sets.sharpness,'',function(v){applyC({sharpness:v});},!!caps.sharpness),
    mkRange('pan','Pan',caps.pan,sets.pan,'deg',function(v){applyC({pan:v});},!!caps.pan),
    mkRange('tilt','Tilt',caps.tilt,sets.tilt,'deg',function(v){applyC({tilt:v});},!!caps.tilt),
  ]);
  buildSec('cStream','Resolution & Frame Rate',null,[
    mkRange('rW','Width',caps.width,sets.width,'px',function(v){track.applyConstraints({width:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.width),
    mkRange('rH','Height',caps.height,sets.height,'px',function(v){track.applyConstraints({height:{ideal:Math.round(v)}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.height),
    mkRange('fps','Frame Rate',caps.frameRate,sets.frameRate,'fps',function(v){track.applyConstraints({frameRate:{ideal:v}}).then(function(){sets=track.getSettings();}).catch(function(){});},!!caps.frameRate),
    mkSel('resMode','Resize Mode',caps.resizeMode,sets.resizeMode,function(v){track.applyConstraints({resizeMode:v}).catch(function(){});},!!caps.resizeMode),
  ]);
  buildSec('cTorch','Torch & Zoom','LIVE',[
    mkTog('tToggle','Torch / Flash',sets.torch||false,function(v){torchOn=v;applyC({torch:v});updateTorch();},!!caps.torch),
    mkRange('zoom','Zoom',caps.zoom,sets.zoom,'x',function(v){applyC({zoom:v});},!!caps.zoom),
  ]);
}

function buildSec(mountId,title,tag,items){
  var el=$(mountId);el.innerHTML='';
  var sec=document.createElement('div');sec.className='section';
  var head=document.createElement('div');head.className='sec-head';
  head.onclick=function(){togSec(head);};
  var left=document.createElement('div');left.className='sec-left';
  var t=document.createElement('span');t.className='sec-title';t.textContent=title;
  left.appendChild(t);
  if(tag){var tg=document.createElement('span');tg.className='sec-tag';tg.textContent=tag;left.appendChild(tg);}
  var ch=document.createElement('span');ch.className='sec-chev';ch.textContent='\u25be';
  head.appendChild(left);head.appendChild(ch);
  var body=document.createElement('div');body.className='sec-body';
  items.forEach(function(i){body.appendChild(i);});
  sec.appendChild(head);sec.appendChild(body);el.appendChild(sec);
}

function fmtV(v,unit){
  if(typeof v!=='number')return '--';
  if(unit==='us')return v>=1000?(v/1000).toFixed(2)+'ms':v.toFixed(0)+'\u00b5s';
  if(unit==='%')return Math.round(v)+'%';
  if(unit==='deg')return Math.round(v)+'\u00b0';
  if(unit==='px')return Math.round(v)+'px';
  if(unit==='fps')return v.toFixed(1)+'fps';
  if(unit==='x')return v.toFixed(2)+'\u00d7';
  if(unit==='m')return v.toFixed(4)+'m';
  if(unit==='EV')return(v>=0?'+':'')+v.toFixed(2)+'EV';
  if(unit==='K')return Math.round(v)+'K';
  return Number.isInteger(v)?v+(unit||''):v.toFixed(2)+(unit||'');
}

function mkRange(id,label,capObj,cur,unit,onChange,supported){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var hd=document.createElement('div');hd.className='ctrl-head';
  var nm=document.createElement('span');nm.className='ctrl-name';nm.textContent=label;hd.appendChild(nm);
  if(!supported){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;
  }
  var mn=capObj&&capObj.min!=null?capObj.min:0;
  var mx=capObj&&capObj.max!=null?capObj.max:100;
  var st=capObj&&capObj.step!=null?capObj.step:((mx-mn)/100)||1;
  var vl=document.createElement('span');vl.className='ctrl-val';vl.id=id+'_v';
  vl.textContent=fmtV(cur!=null?cur:mn,unit);hd.appendChild(vl);wrap.appendChild(hd);
  var ri=document.createElement('div');ri.className='ctrl-range-info';
  ri.innerHTML='<span>'+fmtV(mn,unit)+'</span><span style="color:var(--muted2)">min &mdash; max</span><span>'+fmtV(mx,unit)+'</span>';
  wrap.appendChild(ri);
  var r=document.createElement('input');r.type='range';r.id=id;
  r.min=mn;r.max=mx;r.step=st;r.value=cur!=null?cur:mn;
  r.addEventListener('input',function(){
    var v=parseFloat(r.value);vl.textContent=fmtV(v,unit);onChange(v);
  });
  wrap.appendChild(r);return wrap;
}

function mkSel(id,label,options,cur,onChange,supported){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var hd=document.createElement('div');hd.className='ctrl-head';
  var nm=document.createElement('span');nm.className='ctrl-name';nm.textContent=label;hd.appendChild(nm);
  if(!supported||!options||!options.length){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';hd.appendChild(b);wrap.appendChild(hd);return wrap;
  }
  wrap.appendChild(hd);
  var sel=document.createElement('select');sel.id=id;
  options.forEach(function(o){
    var opt=document.createElement('option');opt.value=o;opt.textContent=o;
    if(o===cur)opt.selected=true;sel.appendChild(opt);
  });
  sel.addEventListener('change',function(){onChange(sel.value);});
  wrap.appendChild(sel);return wrap;
}

function mkTog(id,label,checked,onChange,supported){
  var wrap=document.createElement('div');wrap.className='ctrl';
  var row=document.createElement('div');row.className='tog-row';
  var lbl=document.createElement('span');lbl.className='tog-name';lbl.textContent=label;row.appendChild(lbl);
  if(!supported){
    var b=document.createElement('span');b.className='na-badge';b.textContent='NOT SUPPORTED';row.appendChild(b);wrap.appendChild(row);return wrap;
  }
  var tog=document.createElement('label');tog.className='toggle';
  var inp=document.createElement('input');inp.type='checkbox';inp.checked=checked;inp.id=id;
  inp.addEventListener('change',function(){onChange(inp.checked);});
  var tr=document.createElement('span');tr.className='tog-track';
  tog.appendChild(inp);tog.appendChild(tr);row.appendChild(tog);wrap.appendChild(row);return wrap;
}

/* CAPABILITIES TABLE */
var ALL_PROPS=['width','height','frameRate','aspectRatio','facingMode','resizeMode','zoom','torch',
  'focusMode','focusDistance','exposureMode','exposureTime','exposureCompensation','iso',
  'whiteBalanceMode','colorTemperature','brightness','contrast','saturation','sharpness',
  'pan','tilt','sampleRate','sampleSize','echoCancellation','autoGainControl','noiseSuppression','channelCount','latency'];

function buildCapsTab(){
  var body=$('capBody');body.innerHTML='';
  var done={};
  function renderRow(key,val){
    done[key]=true;
    var tr=document.createElement('tr');
    var td1=document.createElement('td');td1.textContent=key;tr.appendChild(td1);
    var td2=document.createElement('td');
    if(val===undefined||val===null){
      td2.innerHTML='<span class="no">not reported</span>';
    }else if(Array.isArray(val)){
      td2.innerHTML=val.map(function(v){return '<span class="v-chip">'+v+'</span>';}).join('');
    }else if(typeof val==='object'&&('min' in val||'max' in val)){
      var s='';
      if('min' in val&&'max' in val){
        s+='<b style="color:var(--text)">min:</b> '+fmtCapV(key,val.min)+'&nbsp;&nbsp;<b style="color:var(--text)">max:</b> '+fmtCapV(key,val.max);
      }
      if('step' in val)s+='&nbsp;&nbsp;<b style="color:var(--text)">step:</b> '+val.step;
      td2.innerHTML='<span class="ok">'+s+'</span>';
    }else if(typeof val==='boolean'){
      td2.innerHTML=val?'<span class="ok">true</span>':'<span class="no">false</span>';
    }else{
      td2.innerHTML='<span class="ok">'+val+'</span>';
    }
    tr.appendChild(td2);body.appendChild(tr);
  }
  ALL_PROPS.forEach(function(k){renderRow(k,caps[k]);});
  Object.keys(caps).forEach(function(k){if(!done[k])renderRow(k+' *',caps[k]);});
}

function fmtCapV(key,v){
  if(typeof v!=='number')return String(v);
  var umap={width:'px',height:'px',frameRate:'fps',zoom:'x',focusDistance:'m',
    exposureTime:'us',colorTemperature:'K',pan:'deg',tilt:'deg',exposureCompensation:'EV'};
  return fmtV(v,umap[key]||'');
}

/* INFO TAB */
function buildInfoTab(){
  var s=track.getSettings();
  var grid=$('infoGrid');grid.innerHTML='';
  var devLabel='Unknown';
  for(var i=0;i<devs.length;i++){if(devs[i].deviceId===s.deviceId){devLabel=devs[i].label||'Camera '+(i+1);break;}}
  var rows=[
    ['Device',devLabel,true],
    ['Facing',s.facingMode||'--',false],
    ['Resolution',(s.width||'?')+'x'+(s.height||'?'),false],
    ['Frame Rate',s.frameRate?(+s.frameRate).toFixed(2)+' fps':'--',false],
    ['Aspect',s.aspectRatio?(+s.aspectRatio).toFixed(4):'--',false],
    ['Resize',s.resizeMode||'--',false],
    ['Exp Mode',s.exposureMode||'--',false],
    ['Focus Mode',s.focusMode||'--',false],
    ['WB Mode',s.whiteBalanceMode||'--',false],
    ['ISO',s.iso!=null?s.iso:'--',false],
    ['EV',s.exposureCompensation!=null?s.exposureCompensation+'EV':'--',false],
    ['Zoom',s.zoom!=null?s.zoom+'x':'--',false],
    ['Torch',s.torch!=null?(s.torch?'ON':'OFF'):'--',false],
    ['Device ID',(s.deviceId||'--').slice(0,20),true],
  ];
  rows.forEach(function(row){
    var c=document.createElement('div');c.className='ic'+(row[2]?' full':'');
    c.innerHTML='<div class="ik">'+row[0]+'</div><div class="iv">'+row[1]+'</div>';
    grid.appendChild(c);
  });
  var sb=$('setBody');sb.innerHTML='';
  Object.entries(s).forEach(function(pair){
    var k=pair[0],v=pair[1];
    var tr=document.createElement('tr');
    var fmt=typeof v==='number'&&v%1!==0?v.toFixed(6):String(v);
    tr.innerHTML='<td>'+k+'</td><td style="color:var(--a1)">'+fmt+'</td>';
    sb.appendChild(tr);
  });
}

/* OVERLAY */
var ovTimer=null;
function startOv(){
  clearInterval(ovTimer);
  ovTimer=setInterval(function(){
    if(!track)return;
    var s=track.getSettings();
    $('resText').textContent=(s.width||'?')+'x'+(s.height||'?')+' '+((+s.frameRate||0).toFixed(1))+'fps';
    updReadout();
  },1500);
}
function updReadout(){
  if(!track)return;
  var s=track.getSettings();
  var lines=[];
  if(s.focusMode)lines.push('FOC: '+s.focusMode);
  if(s.exposureMode)lines.push('EXP: '+s.exposureMode);
  if(s.iso!=null)lines.push('ISO '+s.iso);
  if(s.zoom!=null&&s.zoom!==1)lines.push((+s.zoom).toFixed(1)+'x');
  $('readout').innerHTML=lines.join('<br>');
}

/* TORCH */
async function toggleTorch(){
  if(!caps.torch){showToast('Torch not supported on this camera','err');return;}
  torchOn=!torchOn;
  await applyC({torch:torchOn});
  updateTorch();
  var t=$('tToggle');if(t)t.checked=torchOn;
}
function updateTorch(){var b=$('torchBtn');torchOn?b.classList.add('on'):b.classList.remove('on');}

/* SNAPSHOT */
async function snap(){
  var fl=$('flash');fl.style.animation='none';fl.style.opacity='0';void fl.offsetWidth;
  fl.style.animation='flashOut 0.4s ease-out forwards';
  try{
    var blob=null;
    if(ic){try{blob=await ic.takePhoto();}catch(e){blob=null;}}
    if(!blob){
      var v=$('video'),c=$('canvas');
      c.width=v.videoWidth;c.height=v.videoHeight;
      c.getContext('2d').drawImage(v,0,0);
      blob=await new Promise(function(r){c.toBlob(r,'image/jpeg',0.97);});
    }
    if(blob){
      var url=URL.createObjectURL(blob);
      var a=document.createElement('a');a.href=url;a.download='prism-'+Date.now()+'.jpg';
      document.body.appendChild(a);a.click();document.body.removeChild(a);
      URL.revokeObjectURL(url);
      showToast('Photo saved!','ok');
    }
  }catch(e){showToast('Capture failed','err');}
}

/* RESET / REFRESH / STOP */
async function resetAll(){
  if(!track)return;
  var o={};
  if(caps.brightness)o.brightness=Math.round((caps.brightness.min+caps.brightness.max)/2);
  if(caps.contrast)o.contrast=Math.round((caps.contrast.min+caps.contrast.max)/2);
  if(caps.saturation)o.saturation=Math.round((caps.saturation.min+caps.saturation.max)/2);
  if(caps.sharpness)o.sharpness=Math.round((caps.sharpness.min+caps.sharpness.max)/2);
  if(caps.exposureCompensation)o.exposureCompensation=0;
  if(caps.zoom)o.zoom=caps.zoom.min;
  if(caps.torch)o.torch=false;
  if(Object.keys(o).length)await applyC(o);
  torchOn=false;updateTorch();buildAll();showToast('Reset to defaults','ok');
}
function refresh(){readCaps();buildAll();showToast('Refreshed','ok');}
function stopCam(){
  clearInterval(ovTimer);
  if(stream)stream.getTracks().forEach(function(t){t.stop();});
  $('video').srcObject=null;stream=null;track=null;ic=null;
  $('app').style.display='none';
  $('initScreen').style.display='flex';
  $('startBtn').disabled=false;$('startBtn').textContent='INITIALIZE CAMERA';
}

/* UI HELPERS */
function togSec(h){h.classList.toggle('closed');h.nextElementSibling.classList.toggle('hidden');}
function showTab(n){
  document.querySelectorAll('.tab-panel').forEach(function(p){p.classList.remove('active');});
  document.querySelectorAll('.tab').forEach(function(t){t.classList.remove('active');});
  $('panel-'+n).classList.add('active');
  $('tab-'+n).classList.add('active');
  $('panelWrap').scrollTop=0;
}
var _toastT=null;
function showToast(msg,type){
  var t=$('toast');t.textContent=msg;t.className='toast show'+(type?' '+type:'');
  clearTimeout(_toastT);_toastT=setTimeout(function(){t.className='toast';},2500);
}
function showInitErr(title,msg,hint){
  $('errTitle').textContent=title;$('errMsg').textContent=msg;$('errBox').style.display='block';
  if(hint){$('hintBox').textContent=hint;$('hintBox').style.display='block';}
}
function hideErr(){$('errBox').style.display='none';$('hintBox').style.display='none';}

</script>
</body>
</html>
